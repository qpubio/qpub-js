"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("react/jsx-runtime");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=n(e),i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)};function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s=function(){return s=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},s.apply(this,arguments)};function a(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})}function c(e,t){var n,o,i,r={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(n=1,o&&(i=2&a[0]?o.return:a[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;switch(o=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,o=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(i=r.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(6===a[0]&&r.label<i[1]){r.label=i[1],i=a;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(a);break}i[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e],o=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function u(e,t,n){if(n||2===arguments.length)for(var o,i=0,r=t.length;i<r;i++)!o&&i in t||(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var l,h,g=function(){function e(e){this.definitions=new Map,this.instances=new Map,this.resolutionStack=[],this.instanceId=e}return e.prototype.register=function(e,t,n){var o,i;if(void 0===n&&(n={}),this.definitions.has(e))throw new Error("Service '".concat(e,"' is already registered in container '").concat(this.instanceId,"'"));this.definitions.set(e,{factory:t,lifetime:null!==(o=n.lifetime)&&void 0!==o?o:"singleton",dependencies:null!==(i=n.dependencies)&&void 0!==i?i:[]})},e.prototype.resolve=function(e){if(this.resolutionStack.includes(e)){var t=u(u([],this.resolutionStack,!0),[e],!1).join(" -> ");throw new Error("Circular dependency detected in container '".concat(this.instanceId,"': ").concat(t))}if(this.instances.has(e))return this.instances.get(e);var n=this.definitions.get(e);if(!n)throw new Error("Service '".concat(e,"' not found in container '").concat(this.instanceId,"'. ")+"Available services: ".concat(Array.from(this.definitions.keys()).join(", ")));this.resolutionStack.push(e);try{var o=n.factory(this);return"singleton"===n.lifetime&&this.instances.set(e,o),o}catch(t){throw new Error("Failed to resolve service '".concat(e,"' in container '").concat(this.instanceId,"': ").concat(t instanceof Error?t.message:String(t)))}finally{this.resolutionStack.pop()}},e.prototype.isRegistered=function(e){return this.definitions.has(e)},e.prototype.isInstantiated=function(e){return this.instances.has(e)},e.prototype.getRegisteredServices=function(){return Array.from(this.definitions.keys())},e.prototype.getInstanceId=function(){return this.instanceId},e.prototype.validate=function(){var e=this,t=new Set(this.definitions.keys());Array.from(this.definitions.entries()).forEach(function(n){for(var o=n[0],i=0,r=n[1].dependencies||[];i<r.length;i++){var s=r[i];if(!t.has(s))throw new Error("Service '".concat(o,"' depends on '").concat(s,"' which is not registered ")+"in container '".concat(e.instanceId,"'"))}}),this.validateCircularDependencies(t)},e.prototype.validateCircularDependencies=function(e){var t=this,n=new Set,o=new Set,i=function(e,r){if(void 0===r&&(r=[]),o.has(e)){var s=u(u([],r,!0),[e],!1).join(" -> ");throw new Error("Circular dependency detected in container '".concat(t.instanceId,"': ").concat(s))}if(!n.has(e)){o.add(e);var a=t.definitions.get(e);if(a&&a.dependencies)for(var c=0,l=a.dependencies;c<l.length;c++){var h=l[c];i(h,u(u([],r,!0),[e],!1))}o.delete(e),n.add(e)}};Array.from(e).forEach(function(e){n.has(e)||i(e)})},e.prototype.clearInstances=function(){this.instances.clear()},e.prototype.reset=function(){this.definitions.clear(),this.instances.clear()},e}(),d={httpHost:"rest.qpub.io",httpPort:null,wsHost:"socket.qpub.io",wsPort:null,isSecure:!0,autoConnect:!0,autoReconnect:!0,autoResubscribe:!0,autoAuthenticate:!0,connectTimeoutMs:1e4,maxReconnectAttempts:10,initialReconnectDelayMs:1e3,maxReconnectDelayMs:3e4,reconnectBackoffMultiplier:1.5,resubscribeIntervalMs:1e3,authenticateRetries:3,authenticateRetryIntervalMs:1e3,pingTimeoutMs:1e4,debug:!1,logLevel:"error"},f=function(){function e(e){void 0===e&&(e={}),this.options=s(s({},d),e)}return e.prototype.getOption=function(e){return e?this.options[e]:this.options},e.prototype.setOption=function(e){this.options=s(s({},this.options),e)},e.prototype.reset=function(){this.options=s({},d)},e}(),p=function(){function e(e,t){void 0===e&&(e={}),this.defaultHeaders=s({"Content-Type":"application/json"},e),this.fetchImpl=t||this.getDefaultFetch()}return e.prototype.getDefaultFetch=function(){return"function"==typeof fetch?fetch.bind(globalThis):this.createNodeFetch()},e.prototype.createNodeFetch=function(){var e=this,t=require("http"),n=require("https"),o=require("url").URL;return function(i,r){return a(e,void 0,void 0,function(){return c(this,function(e){return[2,new Promise(function(e,s){var a="string"==typeof i?new o(i):i instanceof o?i:new o(i.toString()),c="https:"===a.protocol?n:t,u={method:(null==r?void 0:r.method)||"GET",headers:(null==r?void 0:r.headers)||{},hostname:a.hostname,path:a.pathname+a.search,port:a.port||("https:"===a.protocol?443:80)},l=c.request(u,function(t){var n=[];t.on("data",function(e){return n.push(e)}),t.on("end",function(){var o=Buffer.concat(n).toString(),i={ok:t.statusCode>=200&&t.statusCode<300,status:t.statusCode,statusText:t.statusMessage,headers:t.headers,json:function(){return Promise.resolve(JSON.parse(o))},text:function(){return Promise.resolve(o)}};e(i)})});l.on("error",s),(null==r?void 0:r.body)&&l.write(r.body),l.end()})]})})}},e.prototype.request=function(e,t){return a(this,void 0,void 0,function(){var n;return c(this,function(o){switch(o.label){case 0:return[4,this.fetchImpl(e,s(s({},t),{headers:s(s({},this.defaultHeaders),t.headers)}))];case 1:if(!(n=o.sent()).ok)throw new Error("HTTP Error: ".concat(n.status," ").concat(n.statusText));return[2,n.json()]}})})},e.prototype.get=function(e){return a(this,arguments,void 0,function(e,t){return void 0===t&&(t={}),c(this,function(n){return[2,this.request(e,{method:"GET",headers:t})]})})},e.prototype.post=function(e,t){return a(this,arguments,void 0,function(e,t,n){return void 0===n&&(n={}),c(this,function(o){return[2,this.request(e,{method:"POST",headers:n,body:JSON.stringify(t)})]})})},e.prototype.put=function(e,t){return a(this,arguments,void 0,function(e,t,n){return void 0===n&&(n={}),c(this,function(o){return[2,this.request(e,{method:"PUT",headers:n,body:JSON.stringify(t)})]})})},e.prototype.delete=function(e){return a(this,arguments,void 0,function(e,t){return void 0===t&&(t={}),c(this,function(n){return[2,this.request(e,{method:"DELETE",headers:t})]})})},e.prototype.patch=function(e,t){return a(this,arguments,void 0,function(e,t,n){return void 0===n&&(n={}),c(this,function(o){return[2,this.request(e,{method:"PATCH",headers:n,body:JSON.stringify(t)})]})})},e}(),b=function(){function e(e,t,n){this.instanceId=e,this.component=t,this.optionManager=n}return e.prototype.shouldLog=function(t){var n,o;if(!this.optionManager.getOption("debug"))return!1;var i=this.optionManager.getOption("logLevel")||"error";return(null!==(n=e.LOG_LEVEL_MAP[t])&&void 0!==n?n:0)<=(null!==(o=e.LOG_LEVEL_MAP[i])&&void 0!==o?o:0)},e.prototype.formatMessage=function(e,t){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];var i=(new Date).toISOString().split("T")[1].slice(0,-1),r=this.instanceId.slice(-8),s=n.length>0?"".concat(t," ").concat(n.join(" ")):t;return"".concat(i," [").concat(e.toUpperCase(),"] [").concat(this.component,":").concat(r,"] ").concat(s)},e.prototype.log=function(e,t){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];if(this.shouldLog(e)){var i=this.formatMessage.apply(this,u([e,t],n,!1)),r=this.optionManager.getOption("logger");if(r)try{r.apply(void 0,u([e,i],n,!1))}catch(e){}else switch(e){case"error":console.error.apply(console,u([i],n,!1));break;case"warn":console.warn.apply(console,u([i],n,!1));break;case"info":console.info.apply(console,u([i],n,!1));break;case"debug":console.log.apply(console,u([i],n,!1));break;case"trace":console.trace.apply(console,u([i],n,!1))}}},e.prototype.error=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,u(["error",e],t,!1))},e.prototype.warn=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,u(["warn",e],t,!1))},e.prototype.info=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,u(["info",e],t,!1))},e.prototype.debug=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,u(["debug",e],t,!1))},e.prototype.trace=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,u(["trace",e],t,!1))},e.LOG_LEVELS=["error","warn","info","debug","trace"],e.LOG_LEVEL_MAP={error:0,warn:1,info:2,debug:3,trace:4},e}(),v=function(){function e(){this.events=new Map}return e.prototype.on=function(e,t){this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t)},e.prototype.off=function(e,t){var n=this.events.get(e);n&&(n.delete(t),0===n.size&&this.events.delete(e))},e.prototype.once=function(e,t){var n=this,o=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];t.apply(void 0,i),n.off(e,o)};this.on(e,o)},e.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var o=this.events.get(e);o&&o.forEach(function(n){try{n.apply(void 0,t)}catch(t){console.error("Error in event listener for ".concat(e),t)}})},e.prototype.removeAllListeners=function(e){e?this.events.delete(e):this.events.clear()},e.prototype.listenerCount=function(e){var t=this.events.get(e);return t?t.size:0},e.prototype.eventNames=function(){return Array.from(this.events.keys())},e}(),m=function(){function e(){}return e.getSubtleCrypto=function(){return a(this,void 0,void 0,function(){var e;return c(this,function(t){if("undefined"!=typeof window&&window.crypto)return[2,window.crypto.subtle];if("undefined"!=typeof global)try{return(null==(e=global.crypto)?void 0:e.subtle)?[2,e.subtle]:[2,require("crypto").webcrypto.subtle]}catch(e){throw new Error("Crypto is not supported in this environment")}throw new Error("Crypto is not supported in this environment")})})},e.hmacSign=function(e,t){return a(this,void 0,void 0,function(){var n,o,i,r,s,a,u;return c(this,function(c){switch(c.label){case 0:return c.trys.push([0,4,,5]),[4,this.getSubtleCrypto()];case 1:return n=c.sent(),o=new TextEncoder,i=o.encode(t),r=o.encode(e),[4,n.importKey("raw",i,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"])];case 2:return s=c.sent(),[4,n.sign("HMAC",s,r)];case 3:return a=c.sent(),[2,this.arrayBufferToBase64(a)];case 4:throw u=c.sent(),new Error("Signing failed: ".concat(u instanceof Error?u.message:"Unknown error"));case 5:return[2]}})})},e.arrayBufferToBase64=function(e){if("undefined"!=typeof window){var t=new Uint8Array(e).reduce(function(e,t){return e+String.fromCharCode(t)},"");return btoa(t)}return Buffer.from(e).toString("base64")},e}(),k=function(){function e(){}return e.decode=function(e){try{var t=e.split("."),n=t[0],o=t[1],i=JSON.parse(atob(n)),r=JSON.parse(atob(o));if(!i.kid||!r.alias||!r.exp)throw new Error("Missing required JWT fields");return{header:i,payload:r}}catch(e){throw new Error("Invalid JWT format")}},e.isExpired=function(e){try{return 1e3*this.decode(e).payload.exp<=Date.now()}catch(e){return!0}},e.sign=function(e,t,n){return a(this,void 0,void 0,function(){var o,i,r,s,a,u,l;return c(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),o={alg:"HS256",typ:"JWT",kid:t},i=this.base64UrlEncode(JSON.stringify(o)),r=this.base64UrlEncode(JSON.stringify(e)),s="".concat(i,".").concat(r),[4,m.hmacSign(s,n)];case 1:return a=c.sent(),u=this.base64UrlEncode(this.base64Decode(a)),[2,"".concat(i,".").concat(r,".").concat(u)];case 2:throw l=c.sent(),new Error("Failed to sign JWT: ".concat(l instanceof Error?l.message:"Unknown error"));case 3:return[2]}})})},e.base64UrlEncode=function(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},e.base64Decode=function(e){return atob(e)},e}(),y=function(){function e(){}return e.parse=function(e){var t=e.split(":"),n=t[0],o=t[1];if(!n||!o)throw new Error("Invalid API key format");return{apiKeyId:n,privateKey:o}},e}(),S="initialized",C="connecting",w="opened",E="connected",T="disconnected",M="closing",R="closed",A="failed",I="initialized",O="subscribing",P="subscribed",U="unsubscribing",N="unsubscribed",q="paused",x="resumed",D="failed",B="token_updated",L="token_expired",_="token_error",H="auth_error",W=function(e){function t(t,n,o){var i=e.call(this)||this;i.currentToken=null,i._isResetting=!1,i.optionManager=t,i.httpClient=n,i.logger=o,i.abortController=new AbortController,i.logger.debug("AuthManager created");var r=i.optionManager.getOption("tokenRequest");return r?(i.logger.info("Initial token request found - requesting token"),i.requestToken(r).catch(function(e){i.logger.error("Initial token request failed:",e),i.emit(_,{error:e instanceof Error?e:new Error("Unknown error")})})):i.logger.debug("No initial token request provided"),i}return r(t,e),t.prototype.handleError=function(e,t){var n=e instanceof Error?new Error("".concat(t,": ").concat(e.message)):new Error("".concat(t,": Unknown error"));throw this.logger.error("".concat(t,":"),e),t.includes("token")?(this.logger.debug("Emitting TOKEN_ERROR event"),this.emit(_,{error:n})):t.includes("auth")&&(this.logger.debug("Emitting AUTH_ERROR event"),this.emit(H,{error:n,context:t})),n},t.prototype.authenticate=function(){return a(this,void 0,void 0,function(){var e,t,n,o,i,r,s;return c(this,function(a){switch(a.label){case 0:if(this.logger.debug("Authenticate called"),this._isResetting)return this.logger.warn("Authentication blocked - auth manager is resetting"),[2,null];e=this.optionManager.getOption("authenticateRetries")||0,t=this.optionManager.getOption("authenticateRetryIntervalMs")||1e3,n=this.optionManager.getOption("tokenRequest"),this.logger.info("Starting authentication (retries: ".concat(e,", interval: ").concat(t,"ms)")),o=0,a.label=1;case 1:if(!(o<=e))return[3,11];a.label=2;case 2:return a.trys.push([2,8,,10]),this.logger.debug("Authentication attempt ".concat(o+1,"/").concat(e+1)),this._isResetting||this.abortController.signal.aborted?(this.logger.warn("Authentication cancelled - auth manager was reset or aborted"),[2,null]):n?(this.logger.debug("Using token request for authentication"),[4,this.requestToken(n)]):[3,4];case 3:return[2,a.sent()];case 4:return[4,this._authenticate()];case 5:return(null==(i=a.sent())?void 0:i.tokenRequest)?(this.logger.debug("Received token request in response - requesting token"),[4,this.requestToken(i.tokenRequest)]):[3,7];case 6:return[2,a.sent()];case 7:return this.logger.info("Authentication successful"),[2,i];case 8:return r=a.sent(),this.abortController.signal.aborted?(this.logger.warn("Authentication cancelled due to abort"),[2,null]):(s=o===e,this.logger.warn("Authentication attempt ".concat(o+1,"/").concat(e+1," failed:"),r),s?(this.logger.error("All authentication attempts failed"),[2,this.handleError(r,"Authentication failed")]):(this.logger.debug("Retrying authentication in ".concat(t,"ms")),[4,new Promise(function(e){return setTimeout(e,t)})]));case 9:return a.sent(),[3,10];case 10:return o++,[3,1];case 11:return[2,null]}})})},t.prototype._authenticate=function(){return a(this,void 0,void 0,function(){var e,t,n,o;return c(this,function(i){switch(i.label){case 0:return this.logger.debug("Internal authentication started"),e=this.optionManager.getOption("authUrl"),t=this.optionManager.getOption("apiKey"),n=this.optionManager.getOption("authOptions"),this.logger.trace("Auth config:",{hasAuthUrl:!!e,hasApiKey:!!t,hasAuthOptions:!!n}),e||t?e?(this.logger.debug("Sending auth request to: ".concat(e)),[4,this.httpClient.post(e,(null==n?void 0:n.body)||{},s({},null==n?void 0:n.headers))]):(this.logger.debug("No authUrl provided - will use apiKey for authentication"),[2,null]):(this.logger.error("No authentication credentials provided"),[2,this.handleError(new Error("Either authUrl or apiKey must be provided"),"Authentication failed")]);case 1:return o=i.sent(),this.logger.debug("Received auth response"),o.token?(this.logger.debug("Response contains token - decoding and setting"),k.decode(o.token),this.setToken(o.token),[2,o]):o.tokenRequest?(this.logger.debug("Response contains token request"),[2,o]):(this.logger.error("Invalid auth response - no token or tokenRequest"),[2,this.handleError(new Error("Invalid response: expected token or tokenRequest"),"Authentication failed")])}})})},t.prototype.shouldAutoAuthenticate=function(){var e,t=null===(e=this.optionManager.getOption("autoAuthenticate"))||void 0===e||e;return this.logger.trace("shouldAutoAuthenticate: ".concat(t)),t},t.prototype.setToken=function(e){var t;this.logger.debug("Setting new token"),this.currentToken=e;var n=k.decode(e),o=(null===(t=null==n?void 0:n.payload)||void 0===t?void 0:t.exp)?new Date(1e3*n.payload.exp):void 0;o?this.logger.info("Token set - expires at ".concat(o.toISOString())):this.logger.info("Token set - no expiration"),this.logger.debug("Emitting TOKEN_UPDATED event"),this.emit(B,{token:e,expiresAt:o}),this.scheduleTokenRefresh(e)},t.prototype.getToken=function(){return this.logger.trace("getToken called"),this.currentToken&&!k.isExpired(this.currentToken)?(this.logger.trace("Returning valid token"),this.currentToken):(this.currentToken?(this.logger.warn("Current token has expired"),this.emit(L,{expiredAt:new Date,token:this.currentToken}),this.clearToken()):this.logger.trace("No token available"),null)},t.prototype.scheduleTokenRefresh=function(e){var t=this;this.logger.debug("Scheduling token refresh"),this.refreshTimeout&&(this.logger.debug("Clearing existing refresh timeout"),clearTimeout(this.refreshTimeout));try{var n=k.decode(e).payload,o=1e3*n.exp-Date.now()-6e4;if(o>0){var i=new Date(Date.now()+o);this.logger.info("Token refresh scheduled for ".concat(i.toISOString()," (in ").concat(Math.round(o/1e3),"s)")),this.refreshTimeout=setTimeout(function(){t.logger.info("Token refresh timer triggered - clearing token"),t.emit(L,{expiredAt:new Date}),t.clearToken()},o)}else this.logger.warn("Token already expired or about to expire (delay: ".concat(o,"ms)")),this.emit(L,{expiredAt:new Date}),this.clearToken()}catch(e){this.logger.error("Error scheduling token refresh:",e),this.emit(_,{error:e instanceof Error?e:new Error("Unknown error")}),this.clearToken()}},t.prototype.clearToken=function(){this.logger.debug("Clearing token"),this.currentToken=null,this.refreshTimeout&&(this.logger.debug("Clearing refresh timeout"),clearTimeout(this.refreshTimeout),this.refreshTimeout=void 0),this.logger.info("Token cleared")},t.prototype.getAuthHeaders=function(){this.logger.trace("Getting auth headers");var e=this.optionManager.getOption("apiKey"),t=this.getToken(),n=this.optionManager.getOption("alias");if(t)return this.logger.debug("Using Bearer token for auth headers"),{Authorization:"Bearer ".concat(t)};if(e){this.logger.debug("Using Basic auth for auth headers".concat(n?" with alias":""));var o={Authorization:"Basic ".concat(btoa(e))};return n&&(o["X-Alias"]=n),o}return this.logger.error("No authentication credentials available for headers"),this.handleError(new Error("No authentication credentials provided"),"No authentication credentials provided")},t.prototype.getAuthQueryParams=function(){this.logger.trace("Getting auth query params");var e=this.optionManager.getOption("apiKey"),t=this.getToken(),n=this.optionManager.getOption("alias");if(t)return this.logger.debug("Using access_token for query params"),"access_token=".concat(encodeURIComponent(t));if(e){this.logger.debug("Using api_key for query params".concat(n?" with alias":""));var o="api_key=".concat(encodeURIComponent(e));return n&&(o+="&alias=".concat(encodeURIComponent(n))),o}return this.logger.error("No authentication credentials available for query params"),this.handleError(new Error("No authentication credentials available"),"No authentication credentials available")},t.prototype.getAuthenticateUrl=function(e){this.logger.debug("Building authenticate URL for: ".concat(e));var t=this.getAuthQueryParams(),n=e.includes("?")?"&":"?",o="".concat(e).concat(n).concat(t);return this.logger.trace("Authenticate URL built: ".concat(o.substring(0,50),"...")),o},t.prototype.generateToken=function(){return a(this,arguments,void 0,function(e){var t,n,o,i,r,s,a,u;return void 0===e&&(e={}),c(this,function(c){switch(c.label){case 0:if(this.logger.debug("Generating token",e),!(t=this.optionManager.getOption("apiKey")))return this.logger.error("Cannot generate token - no API key provided"),[2,this.handleError(new Error("API key is required"),"Token generation failed")];c.label=1;case 1:return c.trys.push([1,3,,4]),n=y.parse(t),o=n.apiKeyId,i=n.privateKey,this.logger.debug("Parsed API key - keyId: ".concat(o)),r=e.expiresIn||3600,s={exp:Math.floor(Date.now()/1e3)+r},void 0!==e.alias&&(s.alias=e.alias,this.logger.debug("Token alias: ".concat(e.alias))),void 0!==e.permissions&&(s.permissions=e.permissions,this.logger.debug("Token permissions set")),this.logger.debug("Signing token (expires in ".concat(r,"s)")),[4,k.sign(s,o,i)];case 2:return a=c.sent(),this.logger.info("Token generated successfully"),[2,a];case 3:return u=c.sent(),this.logger.error("Token generation failed:",u),[2,this.handleError(u,"Token generation failed")];case 4:return[2]}})})},t.prototype.issueToken=function(){return a(this,arguments,void 0,function(e){var t,n,o,i,r,s,a,u,l;return void 0===e&&(e={}),c(this,function(c){switch(c.label){case 0:if(this.logger.debug("Issuing token from QPub server",e),!(t=this.optionManager.getOption("apiKey")))return this.logger.error("Cannot issue token - no API key provided"),[2,this.handleError(new Error("API key is required for issuing tokens"),"Token issuance failed")];c.label=1;case 1:return c.trys.push([1,3,,4]),n=y.parse(t).apiKeyId,this.logger.debug("Parsed API key - keyId: ".concat(n)),o=this.optionManager.getOption("httpHost"),i=this.optionManager.getOption("httpPort"),r=this.optionManager.getOption("isSecure"),s="".concat(r?"https":"http","://").concat(o).concat(i?":".concat(i):"","/v1"),a="".concat(s,"/key/").concat(n,"/token/issue"),this.logger.debug("Issuing token from: ".concat(a)),[4,this.httpClient.post(a,e,{Authorization:"Basic ".concat(btoa(t))})];case 2:return(u=c.sent()).token?(this.logger.debug("Token received - decoding to validate"),k.decode(u.token),this.logger.info("Token issued successfully from QPub server"),[2,u.token]):(this.logger.error("Invalid token response - no token field"),[2,this.handleError(new Error("Invalid token response from QPub server"),"Token issuance failed")]);case 3:return l=c.sent(),this.logger.error("Token issuance failed:",l),[2,this.handleError(l,"Token issuance failed")];case 4:return[2]}})})},t.prototype.createTokenRequest=function(){return a(this,arguments,void 0,function(e){var t,n,o,i,r,s,a,u,l;return void 0===e&&(e={}),c(this,function(c){switch(c.label){case 0:if(this.logger.debug("Creating token request",e),!(t=this.optionManager.getOption("apiKey")))return this.logger.error("Cannot create token request - no API key provided"),[2,this.handleError(new Error("API key is required for creating token requests"),"Token request creation failed")];c.label=1;case 1:return c.trys.push([1,3,,4]),n=y.parse(t),o=n.apiKeyId,i=n.privateKey,this.logger.debug("Parsed API key - keyId: ".concat(o)),r=Math.floor(Date.now()/1e3),s="".concat(o,".").concat(r),void 0!==e.alias&&(s+=".".concat(e.alias),this.logger.debug("Token request alias: ".concat(e.alias))),void 0!==e.permissions&&(s+=".".concat(JSON.stringify(e.permissions)),this.logger.debug("Token request permissions set")),this.logger.debug("Signing token request data"),[4,m.hmacSign(s,i)];case 2:return a=c.sent(),u={kid:o,timestamp:r,signature:a},void 0!==e.alias&&(u.alias=e.alias),void 0!==e.permissions&&(u.permissions=e.permissions),this.logger.info("Token request created successfully"),[2,u];case 3:return l=c.sent(),this.logger.error("Token request creation failed:",l),[2,this.handleError(l,"Token request creation failed")];case 4:return[2]}})})},t.prototype.requestToken=function(e){return a(this,void 0,void 0,function(){var t,n,o,i,r,s,a;return c(this,function(c){switch(c.label){case 0:this.logger.debug("Requesting token from QPub server",{kid:e.kid,hasAlias:!!e.alias,hasPermissions:!!e.permissions}),c.label=1;case 1:return c.trys.push([1,3,,4]),t=this.optionManager.getOption("httpHost"),n=this.optionManager.getOption("httpPort"),o=this.optionManager.getOption("isSecure"),i="".concat(o?"https":"http","://").concat(t).concat(n?":".concat(n):"","/v1"),r="".concat(i,"/key/").concat(e.kid,"/token/request"),this.logger.debug("Sending token request to: ".concat(r)),[4,this.httpClient.post(r,e,{"Content-Type":"application/json"})];case 2:return(s=c.sent()).token?(this.logger.debug("Token received - decoding and setting"),k.decode(s.token),this.setToken(s.token),this.logger.info("Token request successful"),[2,s]):(this.logger.error("Invalid token response - no token field"),[2,this.handleError(new Error("Invalid response: token not found"),"Token request failed")]);case 3:return a=c.sent(),this.logger.error("Token request failed:",a),[2,this.handleError(a,"Token request failed")];case 4:return[2]}})})},t.prototype.isAuthenticated=function(){var e=null!==this.currentToken;return this.logger.trace("isAuthenticated: ".concat(e)),e},t.prototype.getCurrentToken=function(){return this.logger.trace("getCurrentToken called"),this.currentToken},t.prototype.reset=function(){this.logger.info("Resetting auth manager"),this.logger.debug("Setting reset flag"),this._isResetting=!0,this.logger.debug("Aborting pending operations"),this.abortController.abort(),this.logger.debug("Creating new abort controller"),this.abortController=new AbortController,this.logger.debug("Clearing token and timers"),this.clearToken(),this.logger.debug("Removing all event listeners"),this.removeAllListeners(),this.logger.debug("Clearing reset flag"),this._isResetting=!1,this.logger.info("Auth manager reset complete")},t.prototype.getAbortSignal=function(){return this.logger.trace("getAbortSignal called"),this.abortController.signal},t}(v),j=function(){function e(e){if(this.socket=null,this.logger=e,"undefined"!=typeof window&&window.WebSocket)this.WebSocketImplementation=window.WebSocket;else try{this.WebSocketImplementation=require("ws")}catch(e){throw this.logger.error("WebSocket is not supported in this environment"),new Error("WebSocket is not supported in this environment")}}return e.prototype.getSocket=function(){return this.socket},e.prototype.connect=function(e){var t=this;this.socket&&(this.logger.info("Closing existing WebSocket connection"),this.disconnect()),this.logger.info("Connecting to WebSocket at ".concat(e)),this.socket=new this.WebSocketImplementation(e),this.socket.onerror=function(e){t.logger.error("WebSocket error:",e)}},e.prototype.isConnected=function(){return null!==this.socket&&this.socket.readyState===WebSocket.OPEN},e.prototype.disconnect=function(){if(this.socket){if(this.socket.readyState<WebSocket.CLOSING)try{this.logger.info("Closing WebSocket connection"),this.socket.close()}catch(e){this.logger.error("Error closing socket:",e)}this.socket=null}},e.prototype.send=function(e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)throw this.logger.error("Attempted to send data on a closed WebSocket"),new Error("WebSocket is not connected");this.logger.debug("Sending data: ".concat(e)),this.socket.send(e)},e.prototype.reset=function(){this.logger.info("Resetting WebSocketClient instance"),this.isConnected()&&this.disconnect()},e}();!function(e){e[e.CONNECT=0]="CONNECT",e[e.CONNECTED=1]="CONNECTED",e[e.DISCONNECT=2]="DISCONNECT",e[e.DISCONNECTED=3]="DISCONNECTED",e[e.SUBSCRIBE=4]="SUBSCRIBE",e[e.SUBSCRIBED=5]="SUBSCRIBED",e[e.UNSUBSCRIBE=6]="UNSUBSCRIBE",e[e.UNSUBSCRIBED=7]="UNSUBSCRIBED",e[e.PUBLISH=8]="PUBLISH",e[e.PUBLISHED=9]="PUBLISHED",e[e.MESSAGE=10]="MESSAGE",e[e.ERROR=11]="ERROR",e[e.PING=12]="PING",e[e.PONG=13]="PONG"}(h||(h={})),(l={})[h.CONNECT]="connect",l[h.CONNECTED]="connected",l[h.DISCONNECT]="disconnect",l[h.DISCONNECTED]="disconnected",l[h.SUBSCRIBE]="subscribe",l[h.SUBSCRIBED]="subscribed",l[h.UNSUBSCRIBE]="unsubscribe",l[h.UNSUBSCRIBED]="unsubscribed",l[h.PUBLISH]="publish",l[h.PUBLISHED]="published",l[h.MESSAGE]="message",l[h.ERROR]="error",l[h.PING]="ping",l[h.PONG]="pong",h.CONNECT,h.CONNECTED,h.DISCONNECT,h.DISCONNECTED,h.SUBSCRIBE,h.UNSUBSCRIBE,h.PUBLISH,h.SUBSCRIBED,h.UNSUBSCRIBED,h.PUBLISHED,h.MESSAGE,h.ERROR;var Q=function(e){function t(t){var n=e.call(this)||this;return n.name=t,n.emit(I,{channelName:t}),n}return r(t,e),t.prototype.getName=function(){return this.name},t}(v),F=function(e){function t(t,n,o){var i=e.call(this,t)||this;return i.subscribed=!1,i.pendingSubscribe=!1,i.pendingUnsubscribe=!1,i.operationQueue=[],i.paused=!1,i.pausedMessages=[],i.bufferWhilePaused=!0,i.eventCallbacks=new Map,i.pendingTimeouts=new Set,i.wsClient=n,i.logger=o,i.logger.debug("SocketChannel created for: ".concat(t)),i.messageHandler=function(e){try{var t=JSON.parse(e.data);t.channel===i.name&&(i.logger.trace("Received message for channel ".concat(i.name,":"),t),i.handleMessage(t))}catch(e){i.logger.error("Error parsing message for channel ".concat(i.name,":"),e),i.emit(D,{channelName:i.name,error:e instanceof Error?e:new Error("Unknown error"),action:"message_parsing"})}},i.setupMessageHandler(),i}return r(t,e),t.prototype.setupMessageHandler=function(){var e=this.wsClient.getSocket();e?(this.logger.debug("Setting up message handler for channel: ".concat(this.name)),e.removeEventListener("message",this.messageHandler),e.addEventListener("message",this.messageHandler),this.logger.debug("Message handler attached to socket for channel: ".concat(this.name))):this.logger.warn("Cannot setup message handler - socket not available for channel: ".concat(this.name))},t.prototype.processOperationQueue=function(){if(this.pendingSubscribe||this.pendingUnsubscribe)this.logger.debug("Channel ".concat(this.name," has pending operations - deferring queue processing"));else if(0!==this.operationQueue.length){var e=this.operationQueue.shift();this.logger.info("Processing queued ".concat(e.type," operation for channel: ").concat(this.name," (").concat(this.operationQueue.length," remaining in queue)")),"subscribe"===e.type?this.executeSubscribe(e.callback,e.options):this.executeUnsubscribe(e.callback,e.options)}},t.prototype.transformToConsumerMessages=function(e){var t=e.id,n=e.timestamp,o=e.channel,i=e.action,r=e.error,s=e.messages;return this.logger.trace("Transforming ".concat(s.length," message(s) for channel ").concat(this.name)),s.map(function(e,a){return{action:i,error:r,id:s.length>1?"".concat(t,"-").concat(a):t,timestamp:n,channel:o,alias:e.alias,event:e.event,data:e.data}})},t.prototype.handleMessage=function(e){var t,n=this;switch(this.logger.debug("Handling message action ".concat(e.action," for channel: ").concat(this.name)),e.action){case h.MESSAGE:if(this.isSubscribed()){var o=e,i=this.transformToConsumerMessages(o);this.paused?this.bufferWhilePaused?(this.logger.debug("Channel ".concat(this.name," is paused - buffering ").concat(i.length," message(s)")),(t=this.pausedMessages).push.apply(t,i)):this.logger.debug("Channel ".concat(this.name," is paused - dropping ").concat(i.length," message(s)")):(this.logger.debug("Dispatching ".concat(i.length," message(s) to callback for channel: ").concat(this.name)),i.forEach(function(e){var t;null===(t=n.messageCallback)||void 0===t||t.call(n,e)}))}else this.logger.warn("Received message for channel ".concat(this.name," but not subscribed - ignoring"));break;case h.SUBSCRIBED:this.logger.debug("Received SUBSCRIBED confirmation for channel: ".concat(this.name)),this.subscribed=!0,this.pendingSubscribe=!1,this.logger.info("Channel ".concat(this.name," subscribed successfully (subscription ID: ").concat(e.subscription_id,")")),this.emit(P,{channelName:this.name,subscriptionId:e.subscription_id||""}),this.logger.debug("Processing operation queue after subscription (".concat(this.operationQueue.length," operations queued)")),this.processOperationQueue();break;case h.UNSUBSCRIBED:this.logger.debug("Received UNSUBSCRIBED confirmation for channel: ".concat(this.name)),this.subscribed=!1,this.pendingSubscribe=!1,this.pendingUnsubscribe=!1,this.messageCallback=void 0,this.eventCallbacks.clear(),this.logger.info("Channel ".concat(this.name," unsubscribed (subscription ID: ").concat(e.subscription_id,")")),this.emit(N,{channelName:this.name,subscriptionId:e.subscription_id}),this.logger.debug("Processing operation queue after unsubscription (".concat(this.operationQueue.length," operations queued)")),this.processOperationQueue();break;case h.ERROR:this.logger.error("Channel ".concat(this.name," received error:"),e.error),this.emit(D,{channelName:this.name,error:e.error||new Error("Unknown channel error"),action:"channel_operation"});break;default:this.logger.warn("Unknown action type ".concat(e.action," received for channel: ").concat(this.name))}},t.prototype.publish=function(e,t){return a(this,void 0,void 0,function(){var n,o,i;return c(this,function(r){if(this.logger.debug("Publishing to channel ".concat(this.name).concat((null==t?void 0:t.event)?" (event: ".concat(t.event,")"):"").concat((null==t?void 0:t.alias)?" (alias: ".concat(t.alias,")"):"")),!this.wsClient.isConnected())throw n=new Error("Cannot publish: WebSocket is not connected"),this.logger.error("Publish failed for channel ".concat(this.name,":"),n),n;try{o={data:e,event:null==t?void 0:t.event,alias:null==t?void 0:t.alias},i={action:h.PUBLISH,channel:this.name,messages:[o]},this.logger.trace("Sending publish message for channel ".concat(this.name,":"),i),this.wsClient.send(JSON.stringify(i)),this.logger.info("Published message to channel: ".concat(this.name))}catch(e){throw this.logger.error("Error publishing to channel ".concat(this.name,":"),e),this.emit(D,{channelName:this.name,error:e instanceof Error?e:new Error("Unknown error"),action:"publish"}),e}return[2]})})},t.prototype.subscribe=function(e,t){return a(this,void 0,void 0,function(){var n,o,i,r,s=this;return c(this,function(a){if(n=(null==t?void 0:t.timeout)||1e4,this.logger.debug("Subscribe requested for channel: ".concat(this.name," (subscribed: ").concat(this.subscribed,", event: ").concat(null==t?void 0:t.event,", pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),!this.wsClient.isConnected())throw this.pendingSubscribe=!0,o=new Error("Cannot subscribe: WebSocket is not connected"),this.logger.error("Subscribe failed for channel ".concat(this.name,":"),o),o;if(i=!1,r=!1,null==t?void 0:t.event)if(this.pendingUnsubscribe)this.logger.info("Queueing event subscribe operation for channel ".concat(this.name," (pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),this.operationQueue.push({type:"subscribe",callback:e,options:t}),r=!0,i=!0;else{if(this.isSubscribed()||this.pendingSubscribe)return this.executeSubscribe(e,t),[2,Promise.resolve()];i=!0}else if(this.pendingUnsubscribe||this.pendingSubscribe)this.logger.info("Queueing subscribe operation for channel ".concat(this.name," (pendingUnsubscribe: ").concat(this.pendingUnsubscribe,", pendingSubscribe: ").concat(this.pendingSubscribe,")")),this.operationQueue.push({type:"subscribe",callback:e,options:t}),r=!0,i=!0;else{if(this.isSubscribed())return this.executeSubscribe(e,t),[2,Promise.resolve()];i=!0}return i?[2,new Promise(function(o,i){var a=function(){l(),s.logger.debug("Subscribe resolved for channel: ".concat(s.name)),o()},c=function(e){l(),s.logger.error("Subscribe rejected for channel: ".concat(s.name),e.error),i(e.error)},u=setTimeout(function(){l();var e=new Error("Subscription timeout after ".concat(n,"ms for channel: ").concat(s.name));s.logger.error(e.message),i(e)},n);s.pendingTimeouts.add(u);var l=function(){clearTimeout(u),s.pendingTimeouts.delete(u),s.off(P,a),s.off(D,c)};s.once(P,a),s.once(D,c);try{r||s.executeSubscribe(e,t)}catch(e){l(),i(e)}})]:(this.executeSubscribe(e,t),[2,Promise.resolve()])})})},t.prototype.executeSubscribe=function(e,t){var n=this;if(this.logger.debug("Executing subscribe for channel: ".concat(this.name," (subscribed: ").concat(this.subscribed,", event: ").concat(null==t?void 0:t.event,")")),null==t?void 0:t.event){var o=this.eventCallbacks.get(t.event);if(o||(o=new Set,this.eventCallbacks.set(t.event,o)),o.add(e),this.logger.info('Subscribed to event "'.concat(t.event,'" on channel: ').concat(this.name," (total callbacks for this event: ").concat(o.size,")")),this.isSubscribed()||this.pendingSubscribe)this.logger.debug("Channel ".concat(this.name," already subscribed or subscribing - event callback added without new subscription"));else{this.logger.debug("Channel ".concat(this.name," not subscribed - setting up event-driven subscription")),this.setupMessageHandler(),this.logger.info("Subscribing to channel: ".concat(this.name," (event-driven mode)")),this.emit(O,{channelName:this.name}),this.logger.debug("Creating master callback for event routing on channel: ".concat(this.name)),this.messageCallback=function(e){if(e.event){var t=n.eventCallbacks.get(e.event);t&&(n.logger.trace("Routing message to ".concat(t.size,' callback(s) for event "').concat(e.event,'" on channel: ').concat(n.name)),t.forEach(function(t){return t(e)}))}},this.pendingSubscribe=!0;var i={action:h.SUBSCRIBE,channel:this.name};this.logger.trace("Sending subscribe message for channel ".concat(this.name,":"),i),this.wsClient.send(JSON.stringify(i))}}else{if(this.isSubscribed()&&!this.pendingSubscribe)return this.logger.info("Channel ".concat(this.name," already subscribed - updating to catch-all callback")),this.messageCallback=e,void this.eventCallbacks.clear();this.logger.debug("Setting up catch-all subscription for channel: ".concat(this.name)),this.setupMessageHandler(),this.logger.info("Subscribing to channel: ".concat(this.name," (catch-all mode)")),this.emit(O,{channelName:this.name}),this.messageCallback=e,this.eventCallbacks.clear(),this.pendingSubscribe=!0;var r={action:h.SUBSCRIBE,channel:this.name};this.logger.debug("Sending subscribe request to server for channel: ".concat(this.name)),this.logger.trace("Sending subscribe message for channel ".concat(this.name,":"),r),this.wsClient.send(JSON.stringify(r))}},t.prototype.resubscribe=function(){return a(this,void 0,void 0,function(){var e,t,n,o=this;return c(this,function(i){switch(i.label){case 0:if(this.logger.debug("Resubscribe requested for channel ".concat(this.name," (has callback: ").concat(!!this.messageCallback,", event callbacks: ").concat(this.eventCallbacks.size,")")),!this.messageCallback&&0===this.eventCallbacks.size)return this.logger.debug("Skipping resubscribe for channel ".concat(this.name," - no callbacks registered")),[2];i.label=1;case 1:return i.trys.push([1,6,,7]),this.logger.info("Resubscribing to channel: ".concat(this.name)),e=this.messageCallback,t=new Map(this.eventCallbacks),this.subscribed=!1,this.pendingSubscribe=!1,this.pendingUnsubscribe=!1,t.size>0?(Array.from(t.entries()).forEach(function(e){var t=e[0],n=e[1];Array.from(n).forEach(function(e){o.executeSubscribe(e,{event:t})})}),[4,new Promise(function(e,t){var n=function(){o.off(P,n),o.off(D,i),e()},i=function(e){o.off(P,n),o.off(D,i),t(e.error)};o.once(P,n),o.once(D,i)})]):[3,3];case 2:return i.sent(),[3,5];case 3:return e?(this.executeSubscribe(e),[4,new Promise(function(e,t){var n=function(){o.off(P,n),o.off(D,i),e()},i=function(e){o.off(P,n),o.off(D,i),t(e.error)};o.once(P,n),o.once(D,i)})]):[3,5];case 4:i.sent(),i.label=5;case 5:return[3,7];case 6:throw n=i.sent(),this.logger.error("Resubscribe failed for channel ".concat(this.name,":"),n),this.emit(D,{channelName:this.name,error:n instanceof Error?n:new Error("Unknown error"),action:"resubscribe"}),n;case 7:return[2]}})})},t.prototype.unsubscribe=function(e,t){return a(this,void 0,void 0,function(){var n,o,i,r,s,a,u=this;return c(this,function(c){if(n=(null==t?void 0:t.timeout)||1e4,this.logger.debug("Unsubscribe requested for channel: ".concat(this.name," (subscribed: ").concat(this.subscribed,", event: ").concat(null==t?void 0:t.event,", pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),o=!1,i=!1,null==t?void 0:t.event)if(this.isSubscribed()&&!this.pendingUnsubscribe){if((r=this.eventCallbacks.get(t.event))&&(s=!e||1===r.size&&r.has(e),a=1===this.eventCallbacks.size,o=s&&a),!o)return this.executeUnsubscribe(e,t),[2,Promise.resolve()]}else this.pendingSubscribe||this.pendingUnsubscribe?(this.logger.info("Queueing event unsubscribe operation for channel ".concat(this.name," (pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),this.operationQueue.push({type:"unsubscribe",callback:e,options:t}),i=!0,o=!0):o=!0;else{if(!this.isSubscribed()&&!this.pendingSubscribe)return[2,Promise.resolve()];this.pendingSubscribe||this.pendingUnsubscribe?(this.logger.info("Queueing unsubscribe operation for channel ".concat(this.name," (pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),this.operationQueue.push({type:"unsubscribe",callback:e,options:t}),i=!0,o=!0):o=!0}return o?[2,new Promise(function(o,r){var s=function(){l(),u.logger.debug("Unsubscribe resolved for channel: ".concat(u.name)),o()},a=function(e){l(),u.logger.error("Unsubscribe rejected for channel: ".concat(u.name),e.error),r(e.error)},c=setTimeout(function(){l();var e=new Error("Unsubscription timeout after ".concat(n,"ms for channel: ").concat(u.name));u.logger.error(e.message),r(e)},n);u.pendingTimeouts.add(c);var l=function(){clearTimeout(c),u.pendingTimeouts.delete(c),u.off(N,s),u.off(D,a)};u.once(N,s),u.once(D,a);try{i||u.executeUnsubscribe(e,t)}catch(e){l(),r(e)}})]:(this.executeUnsubscribe(e,t),[2,Promise.resolve()])})})},t.prototype.executeUnsubscribe=function(e,t){if(null==t?void 0:t.event){this.logger.debug('Event-specific unsubscribe requested for event "'.concat(t.event,'" on channel: ').concat(this.name));var n=this.eventCallbacks.get(t.event);if(!n)return void this.logger.debug('No callbacks found for event "'.concat(t.event,'" on channel: ').concat(this.name));if(e?(n.delete(e),0===n.size&&this.eventCallbacks.delete(t.event),this.logger.info('Unsubscribed callback from event "'.concat(t.event,'" on channel: ').concat(this.name," (remaining callbacks: ").concat(n.size,")"))):(this.eventCallbacks.delete(t.event),this.logger.info('Unsubscribed all callbacks from event "'.concat(t.event,'" on channel: ').concat(this.name))),0!==this.eventCallbacks.size||!this.isSubscribed())return void this.logger.debug("Still have ".concat(this.eventCallbacks.size," event(s) with callbacks - keeping channel subscription"));this.logger.info("No more event callbacks - fully unsubscribing from channel: ".concat(this.name))}if(this.logger.debug("Full unsubscribe requested for channel ".concat(this.name," (subscribed: ").concat(this.subscribed,")")),this.isSubscribed()){if(!this.wsClient.isConnected())return this.logger.warn("WebSocket not connected - clearing subscription flag but keeping callback for auto-resubscribe"),this.subscribed=!1,void this.emit(N,{channelName:this.name});this.logger.info("Unsubscribing from channel: ".concat(this.name)),this.emit(U,{channelName:this.name}),this.pendingUnsubscribe=!0;var o={action:h.UNSUBSCRIBE,channel:this.name};this.logger.debug("Sending unsubscribe request to server for channel: ".concat(this.name)),this.logger.trace("Sending unsubscribe message for channel ".concat(this.name,":"),o),this.wsClient.send(JSON.stringify(o))}else this.logger.debug("Channel ".concat(this.name," not subscribed - skipping unsubscribe"))},t.prototype.isSubscribed=function(){return this.subscribed},t.prototype.isPendingSubscribe=function(){return this.pendingSubscribe},t.prototype.setPendingSubscribe=function(e){this.logger.debug("Setting pendingSubscribe to ".concat(e," for channel: ").concat(this.name)),this.pendingSubscribe=e},t.prototype.pause=function(e){this.paused?this.logger.debug("Channel ".concat(this.name," is already paused - ignoring pause request")):(this.paused=!0,void 0!==(null==e?void 0:e.bufferMessages)&&(this.bufferWhilePaused=e.bufferMessages),this.logger.info("Channel ".concat(this.name," paused (buffering: ").concat(this.bufferWhilePaused,")")),this.emit(q,{channelName:this.name,buffering:this.bufferWhilePaused}))},t.prototype.resume=function(){var e=this;if(this.paused){this.paused=!1;var t=this.pausedMessages.length;t>0?(this.logger.info("Channel ".concat(this.name," resumed - delivering ").concat(t," buffered message(s)")),this.pausedMessages.forEach(function(t){var n;null===(n=e.messageCallback)||void 0===n||n.call(e,t)}),this.pausedMessages=[]):this.logger.info("Channel ".concat(this.name," resumed")),this.emit(x,{channelName:this.name,bufferedMessagesDelivered:t})}else this.logger.debug("Channel ".concat(this.name," is not paused - ignoring resume request"))},t.prototype.isPaused=function(){return this.paused},t.prototype.hasCallback=function(){return!!this.messageCallback},t.prototype.clearBufferedMessages=function(){var e=this.pausedMessages.length;e>0&&(this.logger.info("Clearing ".concat(e," buffered message(s) for channel: ").concat(this.name)),this.pausedMessages=[])},t.prototype.reset=function(){this.logger.info("Resetting channel: ".concat(this.name));var e=this.wsClient.getSocket();if(e&&(this.logger.debug("Removing message handler for channel: ".concat(this.name)),e.removeEventListener("message",this.messageHandler)),this.isSubscribed()&&this.wsClient.isConnected())try{this.logger.debug("Unsubscribing channel ".concat(this.name," during reset")),this.unsubscribe()}catch(e){this.logger.warn("Failed to unsubscribe from channel ".concat(this.name," during reset:"),e)}this.logger.debug("Clearing local state for channel: ".concat(this.name)),this.pendingTimeouts.forEach(function(e){clearTimeout(e)}),this.pendingTimeouts.clear(),this.subscribed=!1,this.messageCallback=void 0,this.eventCallbacks.clear(),this.pendingSubscribe=!1,this.pendingUnsubscribe=!1,this.operationQueue=[],this.paused=!1,this.pausedMessages=[],this.removeAllListeners(),this.logger.info("Channel ".concat(this.name," reset complete"))},t}(Q),G=function(e){function t(t,n,o,i,r){var s=e.call(this,t)||this;return s.httpClient=n,s.authManager=o,s.optionManager=i,s.logger=r,s.logger.debug("RestChannel created for: ".concat(t)),s}return r(t,e),t.prototype.publish=function(e,t){return a(this,void 0,void 0,function(){var n,o,i,r,s,a,u,l;return c(this,function(c){switch(c.label){case 0:this.logger.debug("Publishing to REST channel ".concat(this.name).concat((null==t?void 0:t.event)?" (event: ".concat(t.event,")"):"").concat((null==t?void 0:t.alias)?" (alias: ".concat(t.alias,")"):"")),c.label=1;case 1:return c.trys.push([1,3,,4]),n=this.authManager.getAuthHeaders(),o=this.optionManager.getOption("httpHost"),i=this.optionManager.getOption("httpPort"),r=this.optionManager.getOption("isSecure"),s="".concat(r?"https":"http","://").concat(o).concat(i?":".concat(i):"","/v1/channel/").concat(this.name,"/messages"),a={messages:[{alias:null==t?void 0:t.alias,event:null==t?void 0:t.event,data:e}]},this.logger.trace("Sending REST publish to ".concat(s," for channel ").concat(this.name,":"),a),[4,this.httpClient.post(s,a,n)];case 2:return u=c.sent(),this.logger.info("Published message to REST channel: ".concat(this.name)),[2,u];case 3:throw l=c.sent(),this.logger.error("Error publishing to REST channel ".concat(this.name,":"),l),this.emit(D,{channelName:this.name,error:l instanceof Error?l:new Error("Unknown error"),action:"publish"}),l;case 4:return[2]}})})},t.prototype.reset=function(){this.logger.info("Resetting REST channel: ".concat(this.name)),this.removeAllListeners(),this.logger.debug("REST channel ".concat(this.name," reset complete"))},t}(Q),J=function(){function e(e,t){this.channels=new Map,this.channelRefCounts=new Map,this.wsClient=e,this.logger=t}return e.prototype.get=function(e){var t=!this.channels.has(e);t&&(this.logger.debug("Creating new socket channel: ".concat(e)),this.channels.set(e,new F(e,this.wsClient,this.logger)));var n=this.channelRefCounts.get(e)||0;return this.channelRefCounts.set(e,n+1),t||0!==n?this.logger.debug("Channel ".concat(e," reference count: ").concat(n+1)):this.logger.debug("Channel ".concat(e," re-acquired (was kept for auto-resubscribe, ref count: 1)")),this.channels.get(e)},e.prototype.release=function(e){var t=this.channelRefCounts.get(e);if(void 0===t||t<0)this.logger.warn("Attempted to release channel ".concat(e," with no active references"));else if(0!==t)if(1===t){var n=this.channels.get(e);if(n&&n.hasCallback())this.channelRefCounts.set(e,0),this.logger.debug("Last reference to channel ".concat(e," released - keeping for auto-resubscribe (ref count: 0)"));else{if(this.logger.debug("Last reference to channel ".concat(e," released - cleaning up")),n){try{n.reset()}catch(t){this.logger.warn("Failed to reset channel ".concat(e," during cleanup:"),t)}this.channels.delete(e),this.logger.debug("Channel ".concat(e," removed from manager"))}this.channelRefCounts.delete(e)}}else this.channelRefCounts.set(e,t-1),this.logger.debug("Channel ".concat(e," reference count: ").concat(t-1));else this.logger.debug("Attempted to release channel ".concat(e," that has ref count 0 (kept for auto-resubscribe)"))},e.prototype.getAllChannels=function(){return Array.from(this.channels.values())},e.prototype.has=function(e){return this.channels.has(e)},e.prototype.remove=function(e){var t=this.channels.get(e);t&&(t.removeAllListeners(),this.channels.delete(e),this.logger.debug("Channel ".concat(e," removed")))},e.prototype.pendingSubscribeAllChannels=function(){for(var e=0,t=this.getAllChannels();e<t.length;e++){t[e].setPendingSubscribe(!0)}},e.prototype.resubscribeAllChannels=function(){return a(this,void 0,void 0,function(){var e,t,n,o,i,r;return c(this,function(s){switch(s.label){case 0:if(e=this.getAllChannels(),t=e.filter(function(e){return e.hasCallback()}),0===t.length)return this.logger.debug("No channels with active subscriptions to resubscribe"),[2];this.logger.debug("Resubscribing to ".concat(t.length," channel(s)")),n=0,o=t,s.label=1;case 1:if(!(n<o.length))return[3,6];i=o[n],s.label=2;case 2:return s.trys.push([2,4,,5]),[4,i.resubscribe()];case 3:return s.sent(),this.logger.debug("Resubscribed to channel: ".concat(i.getName())),[3,5];case 4:return r=s.sent(),this.logger.error("Failed to resubscribe to channel ".concat(i.getName(),":"),r),[3,5];case 5:return n++,[3,1];case 6:return[2]}})})},e.prototype.reset=function(){this.logger.debug("Resetting all socket channels"),this.channels.forEach(function(e){return e.reset()}),this.channels.clear(),this.channelRefCounts.clear()},e}(),z=function(){function e(e,t,n,o){this.channels=new Map,this.httpClient=e,this.authManager=t,this.optionManager=n,this.logger=o}return e.prototype.get=function(e){return this.channels.has(e)||(this.logger.debug("Creating new REST channel: ".concat(e)),this.channels.set(e,new G(e,this.httpClient,this.authManager,this.optionManager,this.logger))),this.channels.get(e)},e.prototype.publishBatch=function(e,t){return a(this,void 0,void 0,function(){var n,o,i,r,s,a;return c(this,function(c){switch(c.label){case 0:return n=this.authManager.getAuthHeaders(),o=this.optionManager.getOption("httpHost"),i=this.optionManager.getOption("httpPort"),r=this.optionManager.getOption("isSecure"),s="".concat(r?"https":"http","://").concat(o).concat(i?":".concat(i):"","/v1/channels/messages"),a={channels:e,messages:t},this.logger.debug("Publishing batch to ".concat(s)),this.logger.debug("Request payload: ".concat(JSON.stringify(a))),this.logger.debug("Headers: ".concat(JSON.stringify(n))),[4,this.httpClient.post(s,a,n)];case 1:return[2,c.sent()]}})})},e.prototype.has=function(e){return this.channels.has(e)},e.prototype.remove=function(e){var t=this.channels.get(e);t&&(t.removeAllListeners(),this.channels.delete(e),this.logger.debug("REST channel ".concat(e," removed")))},e.prototype.reset=function(){this.logger.debug("Resetting all REST channels"),this.channels.forEach(function(e){return e.reset()}),this.channels.clear()},e}(),K=function(e){function t(t,n,o,i,r){var s=e.call(this)||this;return s.socket=null,s.reconnectAttempts=0,s.isReconnecting=!1,s.isIntentionalDisconnect=!1,s._isResetting=!1,s.pendingPings=new Map,s.pingCounter=0,s.optionManager=t,s.authManager=n,s.wsClient=o,s.channelManager=i,s.logger=r,s.setupAuthListeners(),s.logger.info("Connection instance initialized"),s.emit(S),s}return r(t,e),t.prototype.getAuthenticatedWsUrl=function(){var e=this.optionManager.getOption("isSecure"),t=this.optionManager.getOption("wsHost"),n=this.optionManager.getOption("wsPort"),o="".concat(e?"wss":"ws","://").concat(t).concat(n?":".concat(n):"","/v1");return this.authManager.getAuthenticateUrl(o)},t.prototype.connect=function(){return a(this,void 0,void 0,function(){var e,t;return c(this,function(n){switch(n.label){case 0:if(this._isResetting)return this.logger.debug("Connection attempt blocked - connection is resetting"),[2];n.label=1;case 1:return n.trys.push([1,4,,5]),this.emit(C,{attempt:1}),this.authManager.shouldAutoAuthenticate()?[4,this.authManager.authenticate()]:[3,3];case 2:n.sent(),n.label=3;case 3:return e=this.getAuthenticatedWsUrl(),this.wsClient.connect(e),this.socket=this.wsClient.getSocket(),this.socket&&this.setupSocketListeners(),[3,5];case 4:return t=n.sent(),this.handleAuthError(t),[3,5];case 5:return[2]}})})},t.prototype.isConnected=function(){return this.wsClient.isConnected()},t.prototype.isResetting=function(){return this._isResetting},t.prototype.ping=function(){var e=this;return new Promise(function(t,n){if(e.socket&&e.socket.readyState===WebSocket.OPEN){var o=++e.pingCounter,i=performance.now();e.pendingPings.set(o.toString(),{startTime:i,resolve:t,reject:n});var r=setTimeout(function(){e.pendingPings.delete(o.toString()),n(new Error("Ping timeout"))},e.optionManager.getOption("pingTimeoutMs")||1e4);e.pendingPings.get(o.toString()).timeout=r;var s={action:h.PING,timestamp:o};try{e.socket.send(JSON.stringify(s)),e.logger.debug("Sent ping with ID: ".concat(o))}catch(t){clearTimeout(r),e.pendingPings.delete(o.toString()),n(t instanceof Error?t:new Error(String(t)))}}else n(new Error("WebSocket is not connected"))})},t.prototype.setupSocketListeners=function(){var e=this;this.socket&&(this.socket.onopen=function(){e.logger.info("WebSocket connection opened"),e.reconnectAttempts=0,e.isReconnecting=!1,e.isIntentionalDisconnect=!1,e.emit(w,{}),e.setupPingHandler(),e.optionManager.getOption("autoResubscribe")&&e.channelManager.resubscribeAllChannels()},this.socket.onclose=function(t){e.logger.info("WebSocket connection closed: ".concat(t.code," ").concat(t.reason)),e.pingTimeout&&(clearTimeout(e.pingTimeout),e.pingTimeout=void 0),e.emit(R,{code:t.code,reason:t.reason,wasClean:t.wasClean}),e.channelManager.pendingSubscribeAllChannels(),e.isReconnecting||e.isIntentionalDisconnect||!e.optionManager.getOption("autoReconnect")||e.handleConnectionClosed()},this.socket.onerror=function(t){e.logger.error("WebSocket connection error:",t),e.channelManager.pendingSubscribeAllChannels(),e.emit(A,{error:new Error("WebSocket connection error"),context:"websocket"})},this.socket.onmessage=function(t){try{var n=JSON.parse(t.data);if(e.logger.debug("Received message:",n),n.action===h.CONNECTED){var o=n;e.emit(E,{connectionId:o.connection_id,connectionDetails:o.connection_details})}else n.action===h.DISCONNECTED?e.emit(T,{}):n.action===h.PONG&&e.handlePongResponse(n)}catch(t){e.logger.error("Error processing message:",t),e.emit(A,{error:t instanceof Error?t:new Error("Unknown error"),context:"message_processing"})}},this.logger.debug("Socket listeners configured"))},t.prototype.setupAuthListeners=function(){this.authManager.on(L,this.handleTokenExpired.bind(this)),this.authManager.on(_,this.handleAuthError.bind(this)),this.authManager.on(H,this.handleAuthError.bind(this)),this.logger.debug("Auth listeners configured")},t.prototype.setupPingHandler=function(){var e=this;if(this.socket){var t=this.optionManager.getOption("pingTimeoutMs")||6e4;this.socket.onping=function(){e.logger.debug("Ping received from server (Node.js only)"),e.pingTimeout&&clearTimeout(e.pingTimeout),e.pingTimeout=setTimeout(function(){e.handleConnectionInterrupted()},t)},this.socket.onpong=function(){e.logger.debug("Pong received from server (Node.js only)")},this.logger.debug("Ping handler configured")}},t.prototype.handlePongResponse=function(e){var t,n=null===(t=e.timestamp)||void 0===t?void 0:t.toString();if(n){var o=this.pendingPings.get(n);if(o){var i=performance.now()-o.startTime;o.timeout&&clearTimeout(o.timeout),this.pendingPings.delete(n),this.logger.debug("Ping ".concat(n," completed with RTT: ").concat(i.toFixed(2),"ms")),o.resolve(i)}else this.logger.debug("Received pong for unknown ping ID: ".concat(n))}else this.logger.debug("Received pong without ping ID, ignoring")},t.prototype.handleConnectionInterrupted=function(){this.logger.warn("Connection interrupted - no ping received within timeout period"),this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=void 0),this.disconnect(),this.handleConnectionClosed()},t.prototype.handleConnectionClosed=function(){return a(this,void 0,void 0,function(){var e;return c(this,function(t){switch(t.label){case 0:return(null===(e=this.socket)||void 0===e?void 0:e.readyState)===WebSocket.CLOSING?(this.logger.debug("Connection close handled - socket already closing"),[2]):this.reconnectAttempts>=this.optionManager.getOption("maxReconnectAttempts")?(this.logger.debug("Max reconnection attempts reached - not attempting reconnection"),[2]):this.optionManager.getOption("autoReconnect")?(this.logger.info("Initiating automatic reconnection"),[4,this.attemptReconnection()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},t.prototype.handleTokenExpired=function(){return a(this,void 0,void 0,function(){return c(this,function(e){switch(e.label){case 0:return[4,this.connect()];case 1:return e.sent(),[2]}})})},t.prototype.handleAuthError=function(e){this.emit(A,{error:e,context:"authentication"}),this.disconnect()},t.prototype.calculateReconnectDelay=function(){var e=this.optionManager.getOption("initialReconnectDelayMs"),t=this.optionManager.getOption("maxReconnectDelayMs"),n=this.optionManager.getOption("reconnectBackoffMultiplier"),o=e*Math.pow(n,this.reconnectAttempts);return Math.min(o,t)},t.prototype.attemptReconnection=function(){return a(this,void 0,void 0,function(){var e,t,n,o,i=this;return c(this,function(r){switch(r.label){case 0:if(this.isReconnecting)return this.logger.debug("Reconnection already in progress"),[2];e=this.optionManager.getOption("maxReconnectAttempts"),this.isReconnecting=!0,this.logger.info("Starting reconnection attempts (max: ".concat(e,")")),t=function(){var t,o,r;return c(this,function(s){switch(s.label){case 0:return s.trys.push([0,3,,4]),t=n.calculateReconnectDelay(),n.logger.debug("Reconnection attempt ".concat(n.reconnectAttempts+1,"/").concat(e," after ").concat(t,"ms")),n.emit(C,{attempt:n.reconnectAttempts+1}),[4,new Promise(function(e){return setTimeout(e,t)})];case 1:return s.sent(),o=new Promise(function(e,t){var n,o=!1;n=setTimeout(function(){o||(o=!0,t(new Error("Connection attempt timed out")))},i.optionManager.getOption("connectTimeoutMs")||1e4),i.connect().then(function(){o||(o=!0,clearTimeout(n),setTimeout(function(){var n;(null===(n=i.socket)||void 0===n?void 0:n.readyState)===WebSocket.OPEN?e(!0):t(new Error("WebSocket connection failed"))},100))}).catch(function(e){o||(o=!0,clearTimeout(n),t(e))})}),[4,o];case 2:return s.sent(),[2,{value:void 0}];case 3:return r=s.sent(),n.reconnectAttempts++,n.logger.warn("Reconnection attempt failed: ".concat(r)),n.reconnectAttempts>=e?(n.logger.error("Max reconnection attempts reached"),n.emit(A,{error:r instanceof Error?r:new Error(String(r)),context:"reconnection"}),n.isReconnecting=!1,[2,"break"]):[3,4];case 4:return[2]}})},n=this,r.label=1;case 1:return this.reconnectAttempts<e?[5,t()]:[3,3];case 2:return"object"==typeof(o=r.sent())?[2,o.value]:"break"===o?[3,3]:[3,1];case 3:return[2]}})})},t.prototype.disconnect=function(){this.isReconnecting=!1,this.isIntentionalDisconnect=!0,this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=void 0),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.pendingPings.forEach(function(e,t){e.timeout&&clearTimeout(e.timeout),e.reject(new Error("Connection closed"))}),this.pendingPings.clear(),this.emit(M,{}),this.wsClient.disconnect(),this.emit(R,{})},t.prototype.reset=function(){this.logger.info("Resetting Connection instance"),this._isResetting=!0,this.stopAllPendingOperations(),this.cleanupTimers(),this.emit(M,{}),this.wsClient.disconnect(),this.emit(R,{}),this.resetState(),this.removeAllListeners(),this.logger.info("Connection reset completed")},t.prototype.stopAllPendingOperations=function(){this.isReconnecting=!1,this.pendingPings.forEach(function(e,t){e.timeout&&clearTimeout(e.timeout),e.reject(new Error("Connection reset"))}),this.pendingPings.clear()},t.prototype.cleanupTimers=function(){this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=void 0),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout)},t.prototype.resetState=function(){this.reconnectAttempts=0,this.isIntentionalDisconnect=!1,this._isResetting=!1,this.socket=null,this.wsClient.reset()},t}(v),V=function(){function e(e,t){this.instanceId=e,this.optionManager=t}return e.prototype.createLogger=function(e){return new b(this.instanceId,e,this.optionManager)},e}();function X(e,t,n,o){void 0===o&&(o={}),"socket"===t?function(e,t,n){void 0===n&&(n={}),e.register("optionManager",function(){return new f(n)},{dependencies:[]}),e.register("httpClient",function(){return new p},{dependencies:[]}),e.register("loggerFactory",function(e){return new V(t,e.resolve("optionManager"))},{dependencies:["optionManager"]}),e.register("authLogger",function(e){return e.resolve("loggerFactory").createLogger("AuthManager")},{dependencies:["loggerFactory"]}),e.register("connectionLogger",function(e){return e.resolve("loggerFactory").createLogger("Connection")},{dependencies:["loggerFactory"]}),e.register("wsClientLogger",function(e){return e.resolve("loggerFactory").createLogger("WebSocketClient")},{dependencies:["loggerFactory"]}),e.register("socketChannelLogger",function(e){return e.resolve("loggerFactory").createLogger("SocketChannelManager")},{dependencies:["loggerFactory"]}),e.register("authManager",function(e){return new W(e.resolve("optionManager"),e.resolve("httpClient"),e.resolve("authLogger"))},{dependencies:["optionManager","httpClient","authLogger"]}),e.register("wsClient",function(e){return new j(e.resolve("wsClientLogger"))},{dependencies:["wsClientLogger"]}),e.register("socketChannelManager",function(e){return new J(e.resolve("wsClient"),e.resolve("socketChannelLogger"))},{dependencies:["wsClient","socketChannelLogger"]}),e.register("connection",function(e){return new K(e.resolve("optionManager"),e.resolve("authManager"),e.resolve("wsClient"),e.resolve("socketChannelManager"),e.resolve("connectionLogger"))},{dependencies:["optionManager","authManager","wsClient","socketChannelManager","connectionLogger"]})}(e,n,o):function(e,t,n){void 0===n&&(n={}),e.register("optionManager",function(){return new f(n)},{dependencies:[]}),e.register("httpClient",function(){return new p},{dependencies:[]}),e.register("loggerFactory",function(e){return new V(t,e.resolve("optionManager"))},{dependencies:["optionManager"]}),e.register("authLogger",function(e){return e.resolve("loggerFactory").createLogger("AuthManager")},{dependencies:["loggerFactory"]}),e.register("restChannelLogger",function(e){return e.resolve("loggerFactory").createLogger("RestChannelManager")},{dependencies:["loggerFactory"]}),e.register("authManager",function(e){return new W(e.resolve("optionManager"),e.resolve("httpClient"),e.resolve("authLogger"))},{dependencies:["optionManager","httpClient","authLogger"]}),e.register("restChannelManager",function(e){return new z(e.resolve("httpClient"),e.resolve("authManager"),e.resolve("optionManager"),e.resolve("restChannelLogger"))},{dependencies:["httpClient","authManager","optionManager","restChannelLogger"]})}(e,n,o);try{e.validate()}catch(e){throw new Error("Service container validation failed for ".concat(t," instance '").concat(n,"': ").concat(e instanceof Error?e.message:String(e)))}}var $=function(){function e(e){var t,n;this.instanceId="socket_".concat((t=BigInt(Date.now()).toString(16).padStart(12,"0"),n=Array.from({length:20},function(){return Math.floor(16*Math.random()).toString(16)}).join(""),"".concat(t.slice(0,8),"-").concat(t.slice(8,12),"-7").concat(n.slice(0,3),"-").concat((8+(3&parseInt(n[0],16))).toString(16)).concat(n.slice(3,6),"-").concat(n.slice(6,16)))),this.abortController=new AbortController,this.container=new g(this.instanceId),X(this.container,"socket",this.instanceId,e),this.optionManager=this.container.resolve("optionManager"),this.authManager=this.container.resolve("authManager"),this.connection=this.container.resolve("connection"),this.channels=this.container.resolve("socketChannelManager");var o=this.container.resolve("loggerFactory");this.logger=o.createLogger("Socket"),this.optionManager.getOption("autoConnect")&&(this.logger.info("Auto-connecting socket"),this.connection.connect()),this.logger.info("Socket instance created")}return e.prototype.reset=function(){this.logger.info("Resetting Socket instance"),this.abortController.abort(),this.abortController=new AbortController,this.connection.reset(),this.channels.reset(),this.authManager.reset(),this.optionManager.reset(),this.container.clearInstances(),this.logger.info("Socket instance reset completed")},e.prototype.getAbortSignal=function(){return this.abortController.signal},e.prototype.getInstanceId=function(){return this.instanceId},e}(),Y="undefined"!=typeof window;var Z=o.default.createContext(null),ee=function(){var e=o.default.useContext(Z);if(!e)throw new Error("useSocketContext must be used within a SocketProvider");return e};function te(e){var t=this,n=ee().socket,i=o.default.useState(null),r=i[0],s=i[1],u=o.default.useState("initialized"),l=u[0],h=u[1],g=o.default.useState(null),d=g[0],f=g[1],p=o.default.useState(!1),b=p[0],v=p[1],m=o.default.useState("closed"),k=m[0],y=m[1],S=o.default.useMemo(function(){return"connected"===k&&("initialized"===l||"subscribing"===l||"subscribed"===l)},[k,l]);o.default.useEffect(function(){if(n){var t=n.channels.get(e);s(t);var o=function(){return h("subscribing")},i=function(){return h("subscribed")},r=function(){return h("initialized")},a=function(e){return f(e.error)},c=function(){return v(!0)},u=function(){return v(!1)};return t.on(O,o),t.on(P,i),t.on(N,r),t.on(D,a),t.on(q,c),t.on(x,u),function(){t.off(O,o),t.off(P,i),t.off(N,r),t.off(D,a),t.off(q,c),t.off(x,u),n.channels.release(e)}}},[n,e]),o.default.useEffect(function(){if(n){var e=n.connection.isConnected();y(e?"connected":"closed");var t=function(){return y("connected")},o=function(){return y("closed")},i=function(){return y("failed")};return n.connection.on(w,t),n.connection.on(R,o),n.connection.on(A,i),function(){n.connection.off(w,t),n.connection.off(R,o),n.connection.off(A,i)}}},[n]);var C=o.default.useCallback(function(e,n){return a(t,void 0,void 0,function(){return c(this,function(t){if(!r)throw new Error("Channel not available");return[2,r.subscribe(e,n)]})})},[r]),E=o.default.useCallback(function(e,n){return a(t,void 0,void 0,function(){return c(this,function(t){return r?[2,r.unsubscribe(e,n)]:[2]})})},[r]),T=o.default.useCallback(function(e,n){return a(t,void 0,void 0,function(){return c(this,function(t){if(!r)throw new Error("Channel not available");return[2,r.publish(e,n)]})})},[r]),M=o.default.useCallback(function(){return a(t,void 0,void 0,function(){return c(this,function(e){if(!r)throw new Error("Channel not available");return[2,r.resubscribe()]})})},[r]),I=o.default.useCallback(function(){var e;return null!==(e=null==r?void 0:r.isSubscribed())&&void 0!==e&&e},[r]),U=o.default.useCallback(function(){var e;return null!==(e=null==r?void 0:r.isPendingSubscribe())&&void 0!==e&&e},[r]),B=o.default.useCallback(function(e){r&&r.setPendingSubscribe(e)},[r]),L=o.default.useCallback(function(e){r&&r.pause(e)},[r]),_=o.default.useCallback(function(){r&&r.resume()},[r]),H=o.default.useCallback(function(){var e;return null!==(e=null==r?void 0:r.isPaused())&&void 0!==e&&e},[r]),W=o.default.useCallback(function(){var e;return null!==(e=null==r?void 0:r.hasCallback())&&void 0!==e&&e},[r]),j=o.default.useCallback(function(){r&&r.clearBufferedMessages()},[r]),Q=o.default.useCallback(function(){r&&r.reset()},[r]),F=o.default.useCallback(function(){var t;return null!==(t=null==r?void 0:r.getName())&&void 0!==t?t:e},[r,e]);return{channel:r,status:l,error:d,paused:b,ready:S,subscribe:C,resubscribe:M,unsubscribe:E,publish:T,isSubscribed:I,isPendingSubscribe:U,setPendingSubscribe:B,pause:L,resume:_,isPaused:H,hasCallback:W,clearBufferedMessages:j,reset:Q,getName:F}}exports.Channel=function(e){var t=e.name;return(0,e.children)(te(t))},exports.Socket=$,exports.SocketContext=Z,exports.SocketProvider=function(e){var n=e.children,i=e.options,r=void 0===i?{}:i,a=e.fallback,c=function(){var e=o.default.useState(!1),t=e[0],n=e[1];return o.default.useEffect(function(){n(!0)},[]),t}(),u=o.default.useState(null),l=u[0],h=u[1],g=o.default.useRef(null);o.default.useEffect(function(){var e;if(Y&&c){var t=new $(s({autoConnect:null===(e=r.autoConnect)||void 0===e||e},r));return g.current=t,h(t),function(){try{t.reset()}catch(e){console.warn("[QPub] Error during socket cleanup:",e)}g.current=null}}},[c,JSON.stringify(r)]);var d=o.default.useMemo(function(){return l?{socket:l,instanceId:l.getInstanceId()}:null},[l]);return d?t.jsx(Z.Provider,{value:d,children:n}):a?t.jsx(a,{}):null},exports.useAuth=function(){var e=this,t=ee().socket.authManager,n=o.default.useState(null),i=n[0],r=n[1],s=o.default.useState(!1),u=s[0],l=s[1],h=o.default.useState(!1),g=h[0],d=h[1],f=o.default.useState(null),p=f[0],b=f[1];o.default.useEffect(function(){if(t){var e=t.getToken();r(e),l(!!e);var n=function(e){r(e),l(!0),d(!1),b(null)},o=function(){r(null),l(!1),d(!1)},i=function(e){b(e),d(!1),l(!1)},s=function(e){b(e),d(!1),l(!1)};return t.on(B,n),t.on(L,o),t.on(_,i),t.on(H,s),function(){t.off(B,n),t.off(L,o),t.off(_,i),t.off(H,s)}}},[t]);var v=o.default.useCallback(function(){return a(e,void 0,void 0,function(){var e;return c(this,function(n){switch(n.label){case 0:if(!t||g)return[2,null];d(!0),b(null),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,t.authenticate()];case 2:return[2,n.sent()];case 3:throw e=n.sent(),b(e),d(!1),e;case 4:return[2]}})})},[t,g]),m=o.default.useCallback(function(){t&&t.clearToken()},[t]),k=o.default.useCallback(function(){return!!t&&t.shouldAutoAuthenticate()},[t]),y=o.default.useCallback(function(){if(!t)throw new Error("AuthManager not available");return t.getAuthHeaders()},[t]),S=o.default.useCallback(function(){if(!t)throw new Error("AuthManager not available");return t.getAuthQueryParams()},[t]),C=o.default.useCallback(function(e){if(!t)throw new Error("AuthManager not available");return t.getAuthenticateUrl(e)},[t]),w=o.default.useCallback(function(n){return a(e,void 0,void 0,function(){return c(this,function(e){if(!t)throw new Error("AuthManager not available");return[2,t.requestToken(n)]})})},[t]);return{token:i,isAuthenticated:u,isAuthenticating:g,error:p,authenticate:v,clearToken:m,shouldAutoAuthenticate:k,getAuthHeaders:y,getAuthQueryParams:S,getAuthenticateUrl:C,requestToken:w}},exports.useChannel=te,exports.useConnection=function(){var e=this,t=ee().socket,n=o.default.useState(S),i=n[0],r=n[1],s=o.default.useState(null),u=s[0],l=s[1],h=o.default.useState(null),g=h[0],d=h[1];return o.default.useEffect(function(){if(t){var e=t.connection,n=function(){r(S)},o=function(){r(C)},i=function(){r(w)},s=function(e){r(E),l((null==e?void 0:e.connectionId)||null),d((null==e?void 0:e.connectionDetails)||null)},a=function(){r(T),l(null),d(null)},c=function(){r(M)},u=function(){r(R),l(null),d(null)},h=function(){r(A)};return e.on(S,n),e.on(C,o),e.on(w,i),e.on(E,s),e.on(T,a),e.on(M,c),e.on(R,u),e.on(A,h),r(e.isConnected()?E:T),function(){e.off(S,n),e.off(C,o),e.off(w,i),e.off(E,s),e.off(T,a),e.off(M,c),e.off(R,u),e.off(A,h)}}},[t]),{status:i,connectionId:u,connectionDetails:g,connect:o.default.useCallback(function(){return a(e,void 0,void 0,function(){return c(this,function(e){if(!t)throw new Error("Socket not available");return[2,t.connection.connect()]})})},[t]),isConnected:o.default.useCallback(function(){return!!t&&t.connection.isConnected()},[t]),disconnect:o.default.useCallback(function(){if(!t)throw new Error("Socket not available");return t.connection.disconnect()},[t]),ping:o.default.useCallback(function(){if(!t)throw new Error("Socket not available");return t.connection.ping()},[t]),reset:o.default.useCallback(function(){if(!t)throw new Error("Socket not available");return t.connection.reset()},[t])}},exports.useSocket=function(e){var t=o.default.useState(null),n=t[0],i=t[1];return o.default.useEffect(function(){var t;if(Y){var n=new $(s({autoConnect:null===(t=null==e?void 0:e.autoConnect)||void 0===t||t},e));return i(n),function(){n.reset()}}},[JSON.stringify(e)]),n},exports.useSocketContext=ee;
//# sourceMappingURL=qpub-react.cjs.js.map
