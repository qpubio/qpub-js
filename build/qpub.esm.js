var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};function t(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}var n=function(){return n=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)};function o(e,t,n,o){return new(n||(n=Promise))(function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((o=o.apply(e,t||[])).next())})}function i(e,t){var n,o,i,r={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=a(0),s.throw=a(1),s.return=a(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(r=0)),r;)try{if(n=1,o&&(i=2&a[0]?o.return:a[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;switch(o=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return r.label++,{value:a[1],done:!1};case 5:r.label++,o=a[1],a=[0];continue;case 7:a=r.ops.pop(),r.trys.pop();continue;default:if(!(i=r.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){r=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){r.label=a[1];break}if(6===a[0]&&r.label<i[1]){r.label=i[1],i=a;break}if(i&&r.label<i[2]){r.label=i[2],r.ops.push(a);break}i[2]&&r.ops.pop(),r.trys.pop();continue}a=t.call(e,r)}catch(e){a=[6,e],o=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}function r(e,t,n){if(n||2===arguments.length)for(var o,i=0,r=t.length;i<r;i++)!o&&i in t||(o||(o=Array.prototype.slice.call(t,0,i)),o[i]=t[i]);return e.concat(o||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var s,a,c=function(){function e(e){this.definitions=new Map,this.instances=new Map,this.resolutionStack=[],this.instanceId=e}return e.prototype.register=function(e,t,n){var o,i;if(void 0===n&&(n={}),this.definitions.has(e))throw new Error("Service '".concat(e,"' is already registered in container '").concat(this.instanceId,"'"));this.definitions.set(e,{factory:t,lifetime:null!==(o=n.lifetime)&&void 0!==o?o:"singleton",dependencies:null!==(i=n.dependencies)&&void 0!==i?i:[]})},e.prototype.resolve=function(e){if(this.resolutionStack.includes(e)){var t=r(r([],this.resolutionStack,!0),[e],!1).join(" -> ");throw new Error("Circular dependency detected in container '".concat(this.instanceId,"': ").concat(t))}if(this.instances.has(e))return this.instances.get(e);var n=this.definitions.get(e);if(!n)throw new Error("Service '".concat(e,"' not found in container '").concat(this.instanceId,"'. ")+"Available services: ".concat(Array.from(this.definitions.keys()).join(", ")));this.resolutionStack.push(e);try{var o=n.factory(this);return"singleton"===n.lifetime&&this.instances.set(e,o),o}catch(t){throw new Error("Failed to resolve service '".concat(e,"' in container '").concat(this.instanceId,"': ").concat(t instanceof Error?t.message:String(t)))}finally{this.resolutionStack.pop()}},e.prototype.isRegistered=function(e){return this.definitions.has(e)},e.prototype.isInstantiated=function(e){return this.instances.has(e)},e.prototype.getRegisteredServices=function(){return Array.from(this.definitions.keys())},e.prototype.getInstanceId=function(){return this.instanceId},e.prototype.validate=function(){var e=this,t=new Set(this.definitions.keys());Array.from(this.definitions.entries()).forEach(function(n){for(var o=n[0],i=0,r=n[1].dependencies||[];i<r.length;i++){var s=r[i];if(!t.has(s))throw new Error("Service '".concat(o,"' depends on '").concat(s,"' which is not registered ")+"in container '".concat(e.instanceId,"'"))}}),this.validateCircularDependencies(t)},e.prototype.validateCircularDependencies=function(e){var t=this,n=new Set,o=new Set,i=function(e,s){if(void 0===s&&(s=[]),o.has(e)){var a=r(r([],s,!0),[e],!1).join(" -> ");throw new Error("Circular dependency detected in container '".concat(t.instanceId,"': ").concat(a))}if(!n.has(e)){o.add(e);var c=t.definitions.get(e);if(c&&c.dependencies)for(var u=0,h=c.dependencies;u<h.length;u++){var l=h[u];i(l,r(r([],s,!0),[e],!1))}o.delete(e),n.add(e)}};Array.from(e).forEach(function(e){n.has(e)||i(e)})},e.prototype.clearInstances=function(){this.instances.clear()},e.prototype.reset=function(){this.definitions.clear(),this.instances.clear()},e}(),u={httpHost:"rest.qpub.io",httpPort:null,wsHost:"socket.qpub.io",wsPort:null,isSecure:!0,autoConnect:!0,autoReconnect:!0,autoResubscribe:!0,autoAuthenticate:!0,connectTimeoutMs:1e4,maxReconnectAttempts:10,initialReconnectDelayMs:1e3,maxReconnectDelayMs:3e4,reconnectBackoffMultiplier:1.5,resubscribeIntervalMs:1e3,authenticateRetries:3,authenticateRetryIntervalMs:1e3,pingTimeoutMs:1e4,debug:!1,logLevel:"error"},h=function(){function e(e){void 0===e&&(e={}),this.options=n(n({},u),e)}return e.prototype.getOption=function(e){return e?this.options[e]:this.options},e.prototype.setOption=function(e){this.options=n(n({},this.options),e)},e.prototype.reset=function(){this.options=n({},u)},e}(),l=function(){function e(e,t){void 0===e&&(e={}),this.defaultHeaders=n({"Content-Type":"application/json"},e),this.fetchImpl=t||this.getDefaultFetch()}return e.prototype.getDefaultFetch=function(){return"function"==typeof fetch?fetch.bind(globalThis):this.createNodeFetch()},e.prototype.createNodeFetch=function(){var e=this,t=require("http"),n=require("https"),r=require("url").URL;return function(s,a){return o(e,void 0,void 0,function(){return i(this,function(e){return[2,new Promise(function(e,o){var i="string"==typeof s?new r(s):s instanceof r?s:new r(s.toString()),c="https:"===i.protocol?n:t,u={method:(null==a?void 0:a.method)||"GET",headers:(null==a?void 0:a.headers)||{},hostname:i.hostname,path:i.pathname+i.search,port:i.port||("https:"===i.protocol?443:80)},h=c.request(u,function(t){var n=[];t.on("data",function(e){return n.push(e)}),t.on("end",function(){var o=Buffer.concat(n).toString(),i={ok:t.statusCode>=200&&t.statusCode<300,status:t.statusCode,statusText:t.statusMessage,headers:t.headers,json:function(){return Promise.resolve(JSON.parse(o))},text:function(){return Promise.resolve(o)}};e(i)})});h.on("error",o),(null==a?void 0:a.body)&&h.write(a.body),h.end()})]})})}},e.prototype.request=function(e,t){return o(this,void 0,void 0,function(){var o;return i(this,function(i){switch(i.label){case 0:return[4,this.fetchImpl(e,n(n({},t),{headers:n(n({},this.defaultHeaders),t.headers)}))];case 1:if(!(o=i.sent()).ok)throw new Error("HTTP Error: ".concat(o.status," ").concat(o.statusText));return[2,o.json()]}})})},e.prototype.get=function(e){return o(this,arguments,void 0,function(e,t){return void 0===t&&(t={}),i(this,function(n){return[2,this.request(e,{method:"GET",headers:t})]})})},e.prototype.post=function(e,t){return o(this,arguments,void 0,function(e,t,n){return void 0===n&&(n={}),i(this,function(o){return[2,this.request(e,{method:"POST",headers:n,body:JSON.stringify(t)})]})})},e.prototype.put=function(e,t){return o(this,arguments,void 0,function(e,t,n){return void 0===n&&(n={}),i(this,function(o){return[2,this.request(e,{method:"PUT",headers:n,body:JSON.stringify(t)})]})})},e.prototype.delete=function(e){return o(this,arguments,void 0,function(e,t){return void 0===t&&(t={}),i(this,function(n){return[2,this.request(e,{method:"DELETE",headers:t})]})})},e.prototype.patch=function(e,t){return o(this,arguments,void 0,function(e,t,n){return void 0===n&&(n={}),i(this,function(o){return[2,this.request(e,{method:"PATCH",headers:n,body:JSON.stringify(t)})]})})},e}(),g=function(){function e(e,t,n){this.instanceId=e,this.component=t,this.optionManager=n}return e.prototype.shouldLog=function(t){var n,o;if(!this.optionManager.getOption("debug"))return!1;var i=this.optionManager.getOption("logLevel")||"error";return(null!==(n=e.LOG_LEVEL_MAP[t])&&void 0!==n?n:0)<=(null!==(o=e.LOG_LEVEL_MAP[i])&&void 0!==o?o:0)},e.prototype.formatMessage=function(e,t){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];var i=(new Date).toISOString().split("T")[1].slice(0,-1),r=this.instanceId.slice(-8),s=n.length>0?"".concat(t," ").concat(n.join(" ")):t;return"".concat(i," [").concat(e.toUpperCase(),"] [").concat(this.component,":").concat(r,"] ").concat(s)},e.prototype.log=function(e,t){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];if(this.shouldLog(e)){var i=this.formatMessage.apply(this,r([e,t],n,!1)),s=this.optionManager.getOption("logger");if(s)try{s.apply(void 0,r([e,i],n,!1))}catch(e){}else switch(e){case"error":console.error.apply(console,r([i],n,!1));break;case"warn":console.warn.apply(console,r([i],n,!1));break;case"info":console.info.apply(console,r([i],n,!1));break;case"debug":console.log.apply(console,r([i],n,!1));break;case"trace":console.trace.apply(console,r([i],n,!1))}}},e.prototype.error=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,r(["error",e],t,!1))},e.prototype.warn=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,r(["warn",e],t,!1))},e.prototype.info=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,r(["info",e],t,!1))},e.prototype.debug=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,r(["debug",e],t,!1))},e.prototype.trace=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.log.apply(this,r(["trace",e],t,!1))},e.LOG_LEVELS=["error","warn","info","debug","trace"],e.LOG_LEVEL_MAP={error:0,warn:1,info:2,debug:3,trace:4},e}(),d=function(){function e(){this.events=new Map}return e.prototype.on=function(e,t){this.events.has(e)||this.events.set(e,new Set),this.events.get(e).add(t)},e.prototype.off=function(e,t){var n=this.events.get(e);n&&(n.delete(t),0===n.size&&this.events.delete(e))},e.prototype.once=function(e,t){var n=this,o=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];t.apply(void 0,i),n.off(e,o)};this.on(e,o)},e.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var o=this.events.get(e);o&&o.forEach(function(n){try{n.apply(void 0,t)}catch(t){console.error("Error in event listener for ".concat(e),t)}})},e.prototype.removeAllListeners=function(e){e?this.events.delete(e):this.events.clear()},e.prototype.listenerCount=function(e){var t=this.events.get(e);return t?t.size:0},e.prototype.eventNames=function(){return Array.from(this.events.keys())},e}(),p=function(){function e(){}return e.getSubtleCrypto=function(){return o(this,void 0,void 0,function(){var e;return i(this,function(t){if("undefined"!=typeof window&&window.crypto)return[2,window.crypto.subtle];if("undefined"!=typeof global)try{return(null==(e=global.crypto)?void 0:e.subtle)?[2,e.subtle]:[2,require("crypto").webcrypto.subtle]}catch(e){throw new Error("Crypto is not supported in this environment")}throw new Error("Crypto is not supported in this environment")})})},e.hmacSign=function(e,t){return o(this,void 0,void 0,function(){var n,o,r,s,a,c,u;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),[4,this.getSubtleCrypto()];case 1:return n=i.sent(),o=new TextEncoder,r=o.encode(t),s=o.encode(e),[4,n.importKey("raw",r,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign"])];case 2:return a=i.sent(),[4,n.sign("HMAC",a,s)];case 3:return c=i.sent(),[2,this.arrayBufferToBase64(c)];case 4:throw u=i.sent(),new Error("Signing failed: ".concat(u instanceof Error?u.message:"Unknown error"));case 5:return[2]}})})},e.arrayBufferToBase64=function(e){if("undefined"!=typeof window){var t=new Uint8Array(e).reduce(function(e,t){return e+String.fromCharCode(t)},"");return btoa(t)}return Buffer.from(e).toString("base64")},e}(),f=function(){function e(){}return e.decode=function(e){try{var t=e.split("."),n=t[0],o=t[1],i=JSON.parse(atob(n)),r=JSON.parse(atob(o));if(!i.kid||!r.alias||!r.exp)throw new Error("Missing required JWT fields");return{header:i,payload:r}}catch(e){throw new Error("Invalid JWT format")}},e.isExpired=function(e){try{return 1e3*this.decode(e).payload.exp<=Date.now()}catch(e){return!0}},e.sign=function(e,t,n){return o(this,void 0,void 0,function(){var o,r,s,a,c,u,h;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),o={alg:"HS256",typ:"JWT",kid:t},r=this.base64UrlEncode(JSON.stringify(o)),s=this.base64UrlEncode(JSON.stringify(e)),a="".concat(r,".").concat(s),[4,p.hmacSign(a,n)];case 1:return c=i.sent(),u=this.base64UrlEncode(this.base64Decode(c)),[2,"".concat(r,".").concat(s,".").concat(u)];case 2:throw h=i.sent(),new Error("Failed to sign JWT: ".concat(h instanceof Error?h.message:"Unknown error"));case 3:return[2]}})})},e.base64UrlEncode=function(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")},e.base64Decode=function(e){return atob(e)},e}(),b=function(){function e(){}return e.parse=function(e){var t=e.split(":"),n=t[0],o=t[1];if(!n||!o)throw new Error("Invalid API key format");return{apiKeyId:n,privateKey:o}},e}(),v={INITIALIZED:"initialized",CONNECTING:"connecting",OPENED:"opened",CONNECTED:"connected",DISCONNECTED:"disconnected",CLOSING:"closing",CLOSED:"closed",FAILED:"failed"},m={INITIALIZED:"initialized",SUBSCRIBING:"subscribing",SUBSCRIBED:"subscribed",UNSUBSCRIBING:"unsubscribing",UNSUBSCRIBED:"unsubscribed",PAUSED:"paused",RESUMED:"resumed",FAILED:"failed"},k={TOKEN_UPDATED:"token_updated",TOKEN_EXPIRED:"token_expired",TOKEN_ERROR:"token_error",AUTH_ERROR:"auth_error"},y=function(e){function r(t,n,o){var i=e.call(this)||this;i.currentToken=null,i._isResetting=!1,i.optionManager=t,i.httpClient=n,i.logger=o,i.abortController=new AbortController,i.logger.debug("AuthManager created");var r=i.optionManager.getOption("tokenRequest");return r?(i.logger.info("Initial token request found - requesting token"),i.requestToken(r).catch(function(e){i.logger.error("Initial token request failed:",e),i.emit(k.TOKEN_ERROR,{error:e instanceof Error?e:new Error("Unknown error")})})):i.logger.debug("No initial token request provided"),i}return t(r,e),r.prototype.handleError=function(e,t){var n=e instanceof Error?new Error("".concat(t,": ").concat(e.message)):new Error("".concat(t,": Unknown error"));throw this.logger.error("".concat(t,":"),e),t.includes("token")?(this.logger.debug("Emitting TOKEN_ERROR event"),this.emit(k.TOKEN_ERROR,{error:n})):t.includes("auth")&&(this.logger.debug("Emitting AUTH_ERROR event"),this.emit(k.AUTH_ERROR,{error:n,context:t})),n},r.prototype.authenticate=function(){return o(this,void 0,void 0,function(){var e,t,n,o,r,s,a;return i(this,function(i){switch(i.label){case 0:if(this.logger.debug("Authenticate called"),this._isResetting)return this.logger.warn("Authentication blocked - auth manager is resetting"),[2,null];e=this.optionManager.getOption("authenticateRetries")||0,t=this.optionManager.getOption("authenticateRetryIntervalMs")||1e3,n=this.optionManager.getOption("tokenRequest"),this.logger.info("Starting authentication (retries: ".concat(e,", interval: ").concat(t,"ms)")),o=0,i.label=1;case 1:if(!(o<=e))return[3,11];i.label=2;case 2:return i.trys.push([2,8,,10]),this.logger.debug("Authentication attempt ".concat(o+1,"/").concat(e+1)),this._isResetting||this.abortController.signal.aborted?(this.logger.warn("Authentication cancelled - auth manager was reset or aborted"),[2,null]):n?(this.logger.debug("Using token request for authentication"),[4,this.requestToken(n)]):[3,4];case 3:return[2,i.sent()];case 4:return[4,this._authenticate()];case 5:return(null==(r=i.sent())?void 0:r.tokenRequest)?(this.logger.debug("Received token request in response - requesting token"),[4,this.requestToken(r.tokenRequest)]):[3,7];case 6:return[2,i.sent()];case 7:return this.logger.info("Authentication successful"),[2,r];case 8:return s=i.sent(),this.abortController.signal.aborted?(this.logger.warn("Authentication cancelled due to abort"),[2,null]):(a=o===e,this.logger.warn("Authentication attempt ".concat(o+1,"/").concat(e+1," failed:"),s),a?(this.logger.error("All authentication attempts failed"),[2,this.handleError(s,"Authentication failed")]):(this.logger.debug("Retrying authentication in ".concat(t,"ms")),[4,new Promise(function(e){return setTimeout(e,t)})]));case 9:return i.sent(),[3,10];case 10:return o++,[3,1];case 11:return[2,null]}})})},r.prototype._authenticate=function(){return o(this,void 0,void 0,function(){var e,t,o,r;return i(this,function(i){switch(i.label){case 0:return this.logger.debug("Internal authentication started"),e=this.optionManager.getOption("authUrl"),t=this.optionManager.getOption("apiKey"),o=this.optionManager.getOption("authOptions"),this.logger.trace("Auth config:",{hasAuthUrl:!!e,hasApiKey:!!t,hasAuthOptions:!!o}),e||t?e?(this.logger.debug("Sending auth request to: ".concat(e)),[4,this.httpClient.post(e,(null==o?void 0:o.body)||{},n({},null==o?void 0:o.headers))]):(this.logger.debug("No authUrl provided - will use apiKey for authentication"),[2,null]):(this.logger.error("No authentication credentials provided"),[2,this.handleError(new Error("Either authUrl or apiKey must be provided"),"Authentication failed")]);case 1:return r=i.sent(),this.logger.debug("Received auth response"),r.token?(this.logger.debug("Response contains token - decoding and setting"),f.decode(r.token),this.setToken(r.token),[2,r]):r.tokenRequest?(this.logger.debug("Response contains token request"),[2,r]):(this.logger.error("Invalid auth response - no token or tokenRequest"),[2,this.handleError(new Error("Invalid response: expected token or tokenRequest"),"Authentication failed")])}})})},r.prototype.shouldAutoAuthenticate=function(){var e,t=null===(e=this.optionManager.getOption("autoAuthenticate"))||void 0===e||e;return this.logger.trace("shouldAutoAuthenticate: ".concat(t)),t},r.prototype.setToken=function(e){var t;this.logger.debug("Setting new token"),this.currentToken=e;var n=f.decode(e),o=(null===(t=null==n?void 0:n.payload)||void 0===t?void 0:t.exp)?new Date(1e3*n.payload.exp):void 0;o?this.logger.info("Token set - expires at ".concat(o.toISOString())):this.logger.info("Token set - no expiration"),this.logger.debug("Emitting TOKEN_UPDATED event"),this.emit(k.TOKEN_UPDATED,{token:e,expiresAt:o}),this.scheduleTokenRefresh(e)},r.prototype.getToken=function(){return this.logger.trace("getToken called"),this.currentToken&&!f.isExpired(this.currentToken)?(this.logger.trace("Returning valid token"),this.currentToken):(this.currentToken?(this.logger.warn("Current token has expired"),this.emit(k.TOKEN_EXPIRED,{expiredAt:new Date,token:this.currentToken}),this.clearToken()):this.logger.trace("No token available"),null)},r.prototype.scheduleTokenRefresh=function(e){var t=this;this.logger.debug("Scheduling token refresh"),this.refreshTimeout&&(this.logger.debug("Clearing existing refresh timeout"),clearTimeout(this.refreshTimeout));try{var n=f.decode(e).payload,o=1e3*n.exp-Date.now()-6e4;if(o>0){var i=new Date(Date.now()+o);this.logger.info("Token refresh scheduled for ".concat(i.toISOString()," (in ").concat(Math.round(o/1e3),"s)")),this.refreshTimeout=setTimeout(function(){t.logger.info("Token refresh timer triggered - clearing token"),t.emit(k.TOKEN_EXPIRED,{expiredAt:new Date}),t.clearToken()},o)}else this.logger.warn("Token already expired or about to expire (delay: ".concat(o,"ms)")),this.emit(k.TOKEN_EXPIRED,{expiredAt:new Date}),this.clearToken()}catch(e){this.logger.error("Error scheduling token refresh:",e),this.emit(k.TOKEN_ERROR,{error:e instanceof Error?e:new Error("Unknown error")}),this.clearToken()}},r.prototype.clearToken=function(){this.logger.debug("Clearing token"),this.currentToken=null,this.refreshTimeout&&(this.logger.debug("Clearing refresh timeout"),clearTimeout(this.refreshTimeout),this.refreshTimeout=void 0),this.logger.info("Token cleared")},r.prototype.getAuthHeaders=function(){this.logger.trace("Getting auth headers");var e=this.optionManager.getOption("apiKey"),t=this.getToken(),n=this.optionManager.getOption("alias");if(t)return this.logger.debug("Using Bearer token for auth headers"),{Authorization:"Bearer ".concat(t)};if(e){this.logger.debug("Using Basic auth for auth headers".concat(n?" with alias":""));var o={Authorization:"Basic ".concat(btoa(e))};return n&&(o["X-Alias"]=n),o}return this.logger.error("No authentication credentials available for headers"),this.handleError(new Error("No authentication credentials provided"),"No authentication credentials provided")},r.prototype.getAuthQueryParams=function(){this.logger.trace("Getting auth query params");var e=this.optionManager.getOption("apiKey"),t=this.getToken(),n=this.optionManager.getOption("alias");if(t)return this.logger.debug("Using access_token for query params"),"access_token=".concat(encodeURIComponent(t));if(e){this.logger.debug("Using api_key for query params".concat(n?" with alias":""));var o="api_key=".concat(encodeURIComponent(e));return n&&(o+="&alias=".concat(encodeURIComponent(n))),o}return this.logger.error("No authentication credentials available for query params"),this.handleError(new Error("No authentication credentials available"),"No authentication credentials available")},r.prototype.getAuthenticateUrl=function(e){this.logger.debug("Building authenticate URL for: ".concat(e));var t=this.getAuthQueryParams(),n=e.includes("?")?"&":"?",o="".concat(e).concat(n).concat(t);return this.logger.trace("Authenticate URL built: ".concat(o.substring(0,50),"...")),o},r.prototype.generateToken=function(){return o(this,arguments,void 0,function(e){var t,n,o,r,s,a,c,u;return void 0===e&&(e={}),i(this,function(i){switch(i.label){case 0:if(this.logger.debug("Generating token",e),!(t=this.optionManager.getOption("apiKey")))return this.logger.error("Cannot generate token - no API key provided"),[2,this.handleError(new Error("API key is required"),"Token generation failed")];i.label=1;case 1:return i.trys.push([1,3,,4]),n=b.parse(t),o=n.apiKeyId,r=n.privateKey,this.logger.debug("Parsed API key - keyId: ".concat(o)),s=e.expiresIn||3600,a={exp:Math.floor(Date.now()/1e3)+s},void 0!==e.alias&&(a.alias=e.alias,this.logger.debug("Token alias: ".concat(e.alias))),void 0!==e.permissions&&(a.permissions=e.permissions,this.logger.debug("Token permissions set")),this.logger.debug("Signing token (expires in ".concat(s,"s)")),[4,f.sign(a,o,r)];case 2:return c=i.sent(),this.logger.info("Token generated successfully"),[2,c];case 3:return u=i.sent(),this.logger.error("Token generation failed:",u),[2,this.handleError(u,"Token generation failed")];case 4:return[2]}})})},r.prototype.issueToken=function(){return o(this,arguments,void 0,function(e){var t,n,o,r,s,a,c,u,h;return void 0===e&&(e={}),i(this,function(i){switch(i.label){case 0:if(this.logger.debug("Issuing token from QPub server",e),!(t=this.optionManager.getOption("apiKey")))return this.logger.error("Cannot issue token - no API key provided"),[2,this.handleError(new Error("API key is required for issuing tokens"),"Token issuance failed")];i.label=1;case 1:return i.trys.push([1,3,,4]),n=b.parse(t).apiKeyId,this.logger.debug("Parsed API key - keyId: ".concat(n)),o=this.optionManager.getOption("httpHost"),r=this.optionManager.getOption("httpPort"),s=this.optionManager.getOption("isSecure"),a="".concat(s?"https":"http","://").concat(o).concat(r?":".concat(r):"","/v1"),c="".concat(a,"/key/").concat(n,"/token/issue"),this.logger.debug("Issuing token from: ".concat(c)),[4,this.httpClient.post(c,e,{Authorization:"Basic ".concat(btoa(t))})];case 2:return(u=i.sent()).token?(this.logger.debug("Token received - decoding to validate"),f.decode(u.token),this.logger.info("Token issued successfully from QPub server"),[2,u.token]):(this.logger.error("Invalid token response - no token field"),[2,this.handleError(new Error("Invalid token response from QPub server"),"Token issuance failed")]);case 3:return h=i.sent(),this.logger.error("Token issuance failed:",h),[2,this.handleError(h,"Token issuance failed")];case 4:return[2]}})})},r.prototype.createTokenRequest=function(){return o(this,arguments,void 0,function(e){var t,n,o,r,s,a,c,u,h;return void 0===e&&(e={}),i(this,function(i){switch(i.label){case 0:if(this.logger.debug("Creating token request",e),!(t=this.optionManager.getOption("apiKey")))return this.logger.error("Cannot create token request - no API key provided"),[2,this.handleError(new Error("API key is required for creating token requests"),"Token request creation failed")];i.label=1;case 1:return i.trys.push([1,3,,4]),n=b.parse(t),o=n.apiKeyId,r=n.privateKey,this.logger.debug("Parsed API key - keyId: ".concat(o)),s=Math.floor(Date.now()/1e3),a="".concat(o,".").concat(s),void 0!==e.alias&&(a+=".".concat(e.alias),this.logger.debug("Token request alias: ".concat(e.alias))),void 0!==e.permissions&&(a+=".".concat(JSON.stringify(e.permissions)),this.logger.debug("Token request permissions set")),this.logger.debug("Signing token request data"),[4,p.hmacSign(a,r)];case 2:return c=i.sent(),u={kid:o,timestamp:s,signature:c},void 0!==e.alias&&(u.alias=e.alias),void 0!==e.permissions&&(u.permissions=e.permissions),this.logger.info("Token request created successfully"),[2,u];case 3:return h=i.sent(),this.logger.error("Token request creation failed:",h),[2,this.handleError(h,"Token request creation failed")];case 4:return[2]}})})},r.prototype.requestToken=function(e){return o(this,void 0,void 0,function(){var t,n,o,r,s,a,c;return i(this,function(i){switch(i.label){case 0:this.logger.debug("Requesting token from QPub server",{kid:e.kid,hasAlias:!!e.alias,hasPermissions:!!e.permissions}),i.label=1;case 1:return i.trys.push([1,3,,4]),t=this.optionManager.getOption("httpHost"),n=this.optionManager.getOption("httpPort"),o=this.optionManager.getOption("isSecure"),r="".concat(o?"https":"http","://").concat(t).concat(n?":".concat(n):"","/v1"),s="".concat(r,"/key/").concat(e.kid,"/token/request"),this.logger.debug("Sending token request to: ".concat(s)),[4,this.httpClient.post(s,e,{"Content-Type":"application/json"})];case 2:return(a=i.sent()).token?(this.logger.debug("Token received - decoding and setting"),f.decode(a.token),this.setToken(a.token),this.logger.info("Token request successful"),[2,a]):(this.logger.error("Invalid token response - no token field"),[2,this.handleError(new Error("Invalid response: token not found"),"Token request failed")]);case 3:return c=i.sent(),this.logger.error("Token request failed:",c),[2,this.handleError(c,"Token request failed")];case 4:return[2]}})})},r.prototype.isAuthenticated=function(){var e=null!==this.currentToken;return this.logger.trace("isAuthenticated: ".concat(e)),e},r.prototype.getCurrentToken=function(){return this.logger.trace("getCurrentToken called"),this.currentToken},r.prototype.reset=function(){this.logger.info("Resetting auth manager"),this.logger.debug("Setting reset flag"),this._isResetting=!0,this.logger.debug("Aborting pending operations"),this.abortController.abort(),this.logger.debug("Creating new abort controller"),this.abortController=new AbortController,this.logger.debug("Clearing token and timers"),this.clearToken(),this.logger.debug("Removing all event listeners"),this.removeAllListeners(),this.logger.debug("Clearing reset flag"),this._isResetting=!1,this.logger.info("Auth manager reset complete")},r.prototype.getAbortSignal=function(){return this.logger.trace("getAbortSignal called"),this.abortController.signal},r}(d),S=function(){function e(e){if(this.socket=null,this.logger=e,"undefined"!=typeof window&&window.WebSocket)this.WebSocketImplementation=window.WebSocket;else try{this.WebSocketImplementation=require("ws")}catch(e){throw this.logger.error("WebSocket is not supported in this environment"),new Error("WebSocket is not supported in this environment")}}return e.prototype.getSocket=function(){return this.socket},e.prototype.connect=function(e){var t=this;this.socket&&(this.logger.info("Closing existing WebSocket connection"),this.disconnect()),this.logger.info("Connecting to WebSocket at ".concat(e)),this.socket=new this.WebSocketImplementation(e),this.socket.onerror=function(e){t.logger.error("WebSocket error:",e)}},e.prototype.isConnected=function(){return null!==this.socket&&this.socket.readyState===WebSocket.OPEN},e.prototype.disconnect=function(){if(this.socket){if(this.socket.readyState<WebSocket.CLOSING)try{this.logger.info("Closing WebSocket connection"),this.socket.close()}catch(e){this.logger.error("Error closing socket:",e)}this.socket=null}},e.prototype.send=function(e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)throw this.logger.error("Attempted to send data on a closed WebSocket"),new Error("WebSocket is not connected");this.logger.debug("Sending data: ".concat(e)),this.socket.send(e)},e.prototype.reset=function(){this.logger.info("Resetting WebSocketClient instance"),this.isConnected()&&this.disconnect()},e}();!function(e){e[e.CONNECT=0]="CONNECT",e[e.CONNECTED=1]="CONNECTED",e[e.DISCONNECT=2]="DISCONNECT",e[e.DISCONNECTED=3]="DISCONNECTED",e[e.SUBSCRIBE=4]="SUBSCRIBE",e[e.SUBSCRIBED=5]="SUBSCRIBED",e[e.UNSUBSCRIBE=6]="UNSUBSCRIBE",e[e.UNSUBSCRIBED=7]="UNSUBSCRIBED",e[e.PUBLISH=8]="PUBLISH",e[e.PUBLISHED=9]="PUBLISHED",e[e.MESSAGE=10]="MESSAGE",e[e.ERROR=11]="ERROR",e[e.PING=12]="PING",e[e.PONG=13]="PONG"}(a||(a={})),(s={})[a.CONNECT]="connect",s[a.CONNECTED]="connected",s[a.DISCONNECT]="disconnect",s[a.DISCONNECTED]="disconnected",s[a.SUBSCRIBE]="subscribe",s[a.SUBSCRIBED]="subscribed",s[a.UNSUBSCRIBE]="unsubscribe",s[a.UNSUBSCRIBED]="unsubscribed",s[a.PUBLISH]="publish",s[a.PUBLISHED]="published",s[a.MESSAGE]="message",s[a.ERROR]="error",s[a.PING]="ping",s[a.PONG]="pong",a.CONNECT,a.CONNECTED,a.DISCONNECT,a.DISCONNECTED,a.SUBSCRIBE,a.UNSUBSCRIBE,a.PUBLISH,a.SUBSCRIBED,a.UNSUBSCRIBED,a.PUBLISHED,a.MESSAGE,a.ERROR;var C=function(e){function n(t){var n=e.call(this)||this;return n.name=t,n.emit(m.INITIALIZED,{channelName:t}),n}return t(n,e),n.prototype.getName=function(){return this.name},n}(d),E=function(e){function n(t,n,o){var i=e.call(this,t)||this;return i.subscribed=!1,i.pendingSubscribe=!1,i.pendingUnsubscribe=!1,i.operationQueue=[],i.paused=!1,i.pausedMessages=[],i.bufferWhilePaused=!0,i.eventCallbacks=new Map,i.pendingTimeouts=new Set,i.wsClient=n,i.logger=o,i.logger.debug("SocketChannel created for: ".concat(t)),i.messageHandler=function(e){try{var t=JSON.parse(e.data);t.channel===i.name&&(i.logger.trace("Received message for channel ".concat(i.name,":"),t),i.handleMessage(t))}catch(e){i.logger.error("Error parsing message for channel ".concat(i.name,":"),e),i.emit(m.FAILED,{channelName:i.name,error:e instanceof Error?e:new Error("Unknown error"),action:"message_parsing"})}},i.setupMessageHandler(),i}return t(n,e),n.prototype.setupMessageHandler=function(){var e=this.wsClient.getSocket();e?(this.logger.debug("Setting up message handler for channel: ".concat(this.name)),e.removeEventListener("message",this.messageHandler),e.addEventListener("message",this.messageHandler),this.logger.debug("Message handler attached to socket for channel: ".concat(this.name))):this.logger.warn("Cannot setup message handler - socket not available for channel: ".concat(this.name))},n.prototype.processOperationQueue=function(){if(this.pendingSubscribe||this.pendingUnsubscribe)this.logger.debug("Channel ".concat(this.name," has pending operations - deferring queue processing"));else if(0!==this.operationQueue.length){var e=this.operationQueue.shift();this.logger.info("Processing queued ".concat(e.type," operation for channel: ").concat(this.name," (").concat(this.operationQueue.length," remaining in queue)")),"subscribe"===e.type?this.executeSubscribe(e.callback,e.options):this.executeUnsubscribe(e.callback,e.options)}},n.prototype.transformToConsumerMessages=function(e){var t=e.id,n=e.timestamp,o=e.channel,i=e.action,r=e.error,s=e.messages;return this.logger.trace("Transforming ".concat(s.length," message(s) for channel ").concat(this.name)),s.map(function(e,a){return{action:i,error:r,id:s.length>1?"".concat(t,"-").concat(a):t,timestamp:n,channel:o,alias:e.alias,event:e.event,data:e.data}})},n.prototype.handleMessage=function(e){var t,n=this;switch(this.logger.debug("Handling message action ".concat(e.action," for channel: ").concat(this.name)),e.action){case a.MESSAGE:if(this.isSubscribed()){var o=e,i=this.transformToConsumerMessages(o);this.paused?this.bufferWhilePaused?(this.logger.debug("Channel ".concat(this.name," is paused - buffering ").concat(i.length," message(s)")),(t=this.pausedMessages).push.apply(t,i)):this.logger.debug("Channel ".concat(this.name," is paused - dropping ").concat(i.length," message(s)")):(this.logger.debug("Dispatching ".concat(i.length," message(s) to callback for channel: ").concat(this.name)),i.forEach(function(e){var t;null===(t=n.messageCallback)||void 0===t||t.call(n,e)}))}else this.logger.warn("Received message for channel ".concat(this.name," but not subscribed - ignoring"));break;case a.SUBSCRIBED:this.logger.debug("Received SUBSCRIBED confirmation for channel: ".concat(this.name)),this.subscribed=!0,this.pendingSubscribe=!1,this.logger.info("Channel ".concat(this.name," subscribed successfully (subscription ID: ").concat(e.subscription_id,")")),this.emit(m.SUBSCRIBED,{channelName:this.name,subscriptionId:e.subscription_id||""}),this.logger.debug("Processing operation queue after subscription (".concat(this.operationQueue.length," operations queued)")),this.processOperationQueue();break;case a.UNSUBSCRIBED:this.logger.debug("Received UNSUBSCRIBED confirmation for channel: ".concat(this.name)),this.subscribed=!1,this.pendingSubscribe=!1,this.pendingUnsubscribe=!1,this.messageCallback=void 0,this.eventCallbacks.clear(),this.logger.info("Channel ".concat(this.name," unsubscribed (subscription ID: ").concat(e.subscription_id,")")),this.emit(m.UNSUBSCRIBED,{channelName:this.name,subscriptionId:e.subscription_id}),this.logger.debug("Processing operation queue after unsubscription (".concat(this.operationQueue.length," operations queued)")),this.processOperationQueue();break;case a.ERROR:this.logger.error("Channel ".concat(this.name," received error:"),e.error),this.emit(m.FAILED,{channelName:this.name,error:e.error||new Error("Unknown channel error"),action:"channel_operation"});break;default:this.logger.warn("Unknown action type ".concat(e.action," received for channel: ").concat(this.name))}},n.prototype.publish=function(e,t){return o(this,void 0,void 0,function(){var n,o,r;return i(this,function(i){if(this.logger.debug("Publishing to channel ".concat(this.name).concat((null==t?void 0:t.event)?" (event: ".concat(t.event,")"):"").concat((null==t?void 0:t.alias)?" (alias: ".concat(t.alias,")"):"")),!this.wsClient.isConnected())throw n=new Error("Cannot publish: WebSocket is not connected"),this.logger.error("Publish failed for channel ".concat(this.name,":"),n),n;try{o={data:e,event:null==t?void 0:t.event,alias:null==t?void 0:t.alias},r={action:a.PUBLISH,channel:this.name,messages:[o]},this.logger.trace("Sending publish message for channel ".concat(this.name,":"),r),this.wsClient.send(JSON.stringify(r)),this.logger.info("Published message to channel: ".concat(this.name))}catch(e){throw this.logger.error("Error publishing to channel ".concat(this.name,":"),e),this.emit(m.FAILED,{channelName:this.name,error:e instanceof Error?e:new Error("Unknown error"),action:"publish"}),e}return[2]})})},n.prototype.subscribe=function(e,t){return o(this,void 0,void 0,function(){var n,o,r,s,a=this;return i(this,function(i){if(n=(null==t?void 0:t.timeout)||1e4,this.logger.debug("Subscribe requested for channel: ".concat(this.name," (subscribed: ").concat(this.subscribed,", event: ").concat(null==t?void 0:t.event,", pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),!this.wsClient.isConnected())throw this.pendingSubscribe=!0,o=new Error("Cannot subscribe: WebSocket is not connected"),this.logger.error("Subscribe failed for channel ".concat(this.name,":"),o),o;if(r=!1,s=!1,null==t?void 0:t.event)if(this.pendingUnsubscribe)this.logger.info("Queueing event subscribe operation for channel ".concat(this.name," (pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),this.operationQueue.push({type:"subscribe",callback:e,options:t}),s=!0,r=!0;else{if(this.isSubscribed()||this.pendingSubscribe)return this.executeSubscribe(e,t),[2,Promise.resolve()];r=!0}else if(this.pendingUnsubscribe||this.pendingSubscribe)this.logger.info("Queueing subscribe operation for channel ".concat(this.name," (pendingUnsubscribe: ").concat(this.pendingUnsubscribe,", pendingSubscribe: ").concat(this.pendingSubscribe,")")),this.operationQueue.push({type:"subscribe",callback:e,options:t}),s=!0,r=!0;else{if(this.isSubscribed())return this.executeSubscribe(e,t),[2,Promise.resolve()];r=!0}return r?[2,new Promise(function(o,i){var r=function(){h(),a.logger.debug("Subscribe resolved for channel: ".concat(a.name)),o()},c=function(e){h(),a.logger.error("Subscribe rejected for channel: ".concat(a.name),e.error),i(e.error)},u=setTimeout(function(){h();var e=new Error("Subscription timeout after ".concat(n,"ms for channel: ").concat(a.name));a.logger.error(e.message),i(e)},n);a.pendingTimeouts.add(u);var h=function(){clearTimeout(u),a.pendingTimeouts.delete(u),a.off(m.SUBSCRIBED,r),a.off(m.FAILED,c)};a.once(m.SUBSCRIBED,r),a.once(m.FAILED,c);try{s||a.executeSubscribe(e,t)}catch(e){h(),i(e)}})]:(this.executeSubscribe(e,t),[2,Promise.resolve()])})})},n.prototype.executeSubscribe=function(e,t){var n=this;if(this.logger.debug("Executing subscribe for channel: ".concat(this.name," (subscribed: ").concat(this.subscribed,", event: ").concat(null==t?void 0:t.event,")")),null==t?void 0:t.event){var o=this.eventCallbacks.get(t.event);if(o||(o=new Set,this.eventCallbacks.set(t.event,o)),o.add(e),this.logger.info('Subscribed to event "'.concat(t.event,'" on channel: ').concat(this.name," (total callbacks for this event: ").concat(o.size,")")),this.isSubscribed()||this.pendingSubscribe)this.logger.debug("Channel ".concat(this.name," already subscribed or subscribing - event callback added without new subscription"));else{this.logger.debug("Channel ".concat(this.name," not subscribed - setting up event-driven subscription")),this.setupMessageHandler(),this.logger.info("Subscribing to channel: ".concat(this.name," (event-driven mode)")),this.emit(m.SUBSCRIBING,{channelName:this.name}),this.logger.debug("Creating master callback for event routing on channel: ".concat(this.name)),this.messageCallback=function(e){if(e.event){var t=n.eventCallbacks.get(e.event);t&&(n.logger.trace("Routing message to ".concat(t.size,' callback(s) for event "').concat(e.event,'" on channel: ').concat(n.name)),t.forEach(function(t){return t(e)}))}},this.pendingSubscribe=!0;var i={action:a.SUBSCRIBE,channel:this.name};this.logger.trace("Sending subscribe message for channel ".concat(this.name,":"),i),this.wsClient.send(JSON.stringify(i))}}else{if(this.isSubscribed()&&!this.pendingSubscribe)return this.logger.info("Channel ".concat(this.name," already subscribed - updating to catch-all callback")),this.messageCallback=e,void this.eventCallbacks.clear();this.logger.debug("Setting up catch-all subscription for channel: ".concat(this.name)),this.setupMessageHandler(),this.logger.info("Subscribing to channel: ".concat(this.name," (catch-all mode)")),this.emit(m.SUBSCRIBING,{channelName:this.name}),this.messageCallback=e,this.eventCallbacks.clear(),this.pendingSubscribe=!0;var r={action:a.SUBSCRIBE,channel:this.name};this.logger.debug("Sending subscribe request to server for channel: ".concat(this.name)),this.logger.trace("Sending subscribe message for channel ".concat(this.name,":"),r),this.wsClient.send(JSON.stringify(r))}},n.prototype.resubscribe=function(){return o(this,void 0,void 0,function(){var e,t,n,o=this;return i(this,function(i){switch(i.label){case 0:if(this.logger.debug("Resubscribe requested for channel ".concat(this.name," (has callback: ").concat(!!this.messageCallback,", event callbacks: ").concat(this.eventCallbacks.size,")")),!this.messageCallback&&0===this.eventCallbacks.size)return this.logger.debug("Skipping resubscribe for channel ".concat(this.name," - no callbacks registered")),[2];i.label=1;case 1:return i.trys.push([1,6,,7]),this.logger.info("Resubscribing to channel: ".concat(this.name)),e=this.messageCallback,t=new Map(this.eventCallbacks),this.subscribed=!1,this.pendingSubscribe=!1,this.pendingUnsubscribe=!1,t.size>0?(Array.from(t.entries()).forEach(function(e){var t=e[0],n=e[1];Array.from(n).forEach(function(e){o.executeSubscribe(e,{event:t})})}),[4,new Promise(function(e,t){var n=function(){o.off(m.SUBSCRIBED,n),o.off(m.FAILED,i),e()},i=function(e){o.off(m.SUBSCRIBED,n),o.off(m.FAILED,i),t(e.error)};o.once(m.SUBSCRIBED,n),o.once(m.FAILED,i)})]):[3,3];case 2:return i.sent(),[3,5];case 3:return e?(this.executeSubscribe(e),[4,new Promise(function(e,t){var n=function(){o.off(m.SUBSCRIBED,n),o.off(m.FAILED,i),e()},i=function(e){o.off(m.SUBSCRIBED,n),o.off(m.FAILED,i),t(e.error)};o.once(m.SUBSCRIBED,n),o.once(m.FAILED,i)})]):[3,5];case 4:i.sent(),i.label=5;case 5:return[3,7];case 6:throw n=i.sent(),this.logger.error("Resubscribe failed for channel ".concat(this.name,":"),n),this.emit(m.FAILED,{channelName:this.name,error:n instanceof Error?n:new Error("Unknown error"),action:"resubscribe"}),n;case 7:return[2]}})})},n.prototype.unsubscribe=function(e,t){return o(this,void 0,void 0,function(){var n,o,r,s,a,c,u=this;return i(this,function(i){if(n=(null==t?void 0:t.timeout)||1e4,this.logger.debug("Unsubscribe requested for channel: ".concat(this.name," (subscribed: ").concat(this.subscribed,", event: ").concat(null==t?void 0:t.event,", pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),o=!1,r=!1,null==t?void 0:t.event)if(this.isSubscribed()&&!this.pendingUnsubscribe){if((s=this.eventCallbacks.get(t.event))&&(a=!e||1===s.size&&s.has(e),c=1===this.eventCallbacks.size,o=a&&c),!o)return this.executeUnsubscribe(e,t),[2,Promise.resolve()]}else this.pendingSubscribe||this.pendingUnsubscribe?(this.logger.info("Queueing event unsubscribe operation for channel ".concat(this.name," (pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),this.operationQueue.push({type:"unsubscribe",callback:e,options:t}),r=!0,o=!0):o=!0;else{if(!this.isSubscribed()&&!this.pendingSubscribe)return[2,Promise.resolve()];this.pendingSubscribe||this.pendingUnsubscribe?(this.logger.info("Queueing unsubscribe operation for channel ".concat(this.name," (pendingSubscribe: ").concat(this.pendingSubscribe,", pendingUnsubscribe: ").concat(this.pendingUnsubscribe,")")),this.operationQueue.push({type:"unsubscribe",callback:e,options:t}),r=!0,o=!0):o=!0}return o?[2,new Promise(function(o,i){var s=function(){h(),u.logger.debug("Unsubscribe resolved for channel: ".concat(u.name)),o()},a=function(e){h(),u.logger.error("Unsubscribe rejected for channel: ".concat(u.name),e.error),i(e.error)},c=setTimeout(function(){h();var e=new Error("Unsubscription timeout after ".concat(n,"ms for channel: ").concat(u.name));u.logger.error(e.message),i(e)},n);u.pendingTimeouts.add(c);var h=function(){clearTimeout(c),u.pendingTimeouts.delete(c),u.off(m.UNSUBSCRIBED,s),u.off(m.FAILED,a)};u.once(m.UNSUBSCRIBED,s),u.once(m.FAILED,a);try{r||u.executeUnsubscribe(e,t)}catch(e){h(),i(e)}})]:(this.executeUnsubscribe(e,t),[2,Promise.resolve()])})})},n.prototype.executeUnsubscribe=function(e,t){if(null==t?void 0:t.event){this.logger.debug('Event-specific unsubscribe requested for event "'.concat(t.event,'" on channel: ').concat(this.name));var n=this.eventCallbacks.get(t.event);if(!n)return void this.logger.debug('No callbacks found for event "'.concat(t.event,'" on channel: ').concat(this.name));if(e?(n.delete(e),0===n.size&&this.eventCallbacks.delete(t.event),this.logger.info('Unsubscribed callback from event "'.concat(t.event,'" on channel: ').concat(this.name," (remaining callbacks: ").concat(n.size,")"))):(this.eventCallbacks.delete(t.event),this.logger.info('Unsubscribed all callbacks from event "'.concat(t.event,'" on channel: ').concat(this.name))),0!==this.eventCallbacks.size||!this.isSubscribed())return void this.logger.debug("Still have ".concat(this.eventCallbacks.size," event(s) with callbacks - keeping channel subscription"));this.logger.info("No more event callbacks - fully unsubscribing from channel: ".concat(this.name))}if(this.logger.debug("Full unsubscribe requested for channel ".concat(this.name," (subscribed: ").concat(this.subscribed,")")),this.isSubscribed()){if(!this.wsClient.isConnected())return this.logger.warn("WebSocket not connected - clearing subscription flag but keeping callback for auto-resubscribe"),this.subscribed=!1,void this.emit(m.UNSUBSCRIBED,{channelName:this.name});this.logger.info("Unsubscribing from channel: ".concat(this.name)),this.emit(m.UNSUBSCRIBING,{channelName:this.name}),this.pendingUnsubscribe=!0;var o={action:a.UNSUBSCRIBE,channel:this.name};this.logger.debug("Sending unsubscribe request to server for channel: ".concat(this.name)),this.logger.trace("Sending unsubscribe message for channel ".concat(this.name,":"),o),this.wsClient.send(JSON.stringify(o))}else this.logger.debug("Channel ".concat(this.name," not subscribed - skipping unsubscribe"))},n.prototype.isSubscribed=function(){return this.subscribed},n.prototype.isPendingSubscribe=function(){return this.pendingSubscribe},n.prototype.setPendingSubscribe=function(e){this.logger.debug("Setting pendingSubscribe to ".concat(e," for channel: ").concat(this.name)),this.pendingSubscribe=e},n.prototype.pause=function(e){this.paused?this.logger.debug("Channel ".concat(this.name," is already paused - ignoring pause request")):(this.paused=!0,void 0!==(null==e?void 0:e.bufferMessages)&&(this.bufferWhilePaused=e.bufferMessages),this.logger.info("Channel ".concat(this.name," paused (buffering: ").concat(this.bufferWhilePaused,")")),this.emit(m.PAUSED,{channelName:this.name,buffering:this.bufferWhilePaused}))},n.prototype.resume=function(){var e=this;if(this.paused){this.paused=!1;var t=this.pausedMessages.length;t>0?(this.logger.info("Channel ".concat(this.name," resumed - delivering ").concat(t," buffered message(s)")),this.pausedMessages.forEach(function(t){var n;null===(n=e.messageCallback)||void 0===n||n.call(e,t)}),this.pausedMessages=[]):this.logger.info("Channel ".concat(this.name," resumed")),this.emit(m.RESUMED,{channelName:this.name,bufferedMessagesDelivered:t})}else this.logger.debug("Channel ".concat(this.name," is not paused - ignoring resume request"))},n.prototype.isPaused=function(){return this.paused},n.prototype.hasCallback=function(){return!!this.messageCallback},n.prototype.clearBufferedMessages=function(){var e=this.pausedMessages.length;e>0&&(this.logger.info("Clearing ".concat(e," buffered message(s) for channel: ").concat(this.name)),this.pausedMessages=[])},n.prototype.reset=function(){this.logger.info("Resetting channel: ".concat(this.name));var e=this.wsClient.getSocket();if(e&&(this.logger.debug("Removing message handler for channel: ".concat(this.name)),e.removeEventListener("message",this.messageHandler)),this.isSubscribed()&&this.wsClient.isConnected())try{this.logger.debug("Unsubscribing channel ".concat(this.name," during reset")),this.unsubscribe()}catch(e){this.logger.warn("Failed to unsubscribe from channel ".concat(this.name," during reset:"),e)}this.logger.debug("Clearing local state for channel: ".concat(this.name)),this.pendingTimeouts.forEach(function(e){clearTimeout(e)}),this.pendingTimeouts.clear(),this.subscribed=!1,this.messageCallback=void 0,this.eventCallbacks.clear(),this.pendingSubscribe=!1,this.pendingUnsubscribe=!1,this.operationQueue=[],this.paused=!1,this.pausedMessages=[],this.removeAllListeners(),this.logger.info("Channel ".concat(this.name," reset complete"))},n}(C),w=function(e){function n(t,n,o,i,r){var s=e.call(this,t)||this;return s.httpClient=n,s.authManager=o,s.optionManager=i,s.logger=r,s.logger.debug("RestChannel created for: ".concat(t)),s}return t(n,e),n.prototype.publish=function(e,t){return o(this,void 0,void 0,function(){var n,o,r,s,a,c,u,h;return i(this,function(i){switch(i.label){case 0:this.logger.debug("Publishing to REST channel ".concat(this.name).concat((null==t?void 0:t.event)?" (event: ".concat(t.event,")"):"").concat((null==t?void 0:t.alias)?" (alias: ".concat(t.alias,")"):"")),i.label=1;case 1:return i.trys.push([1,3,,4]),n=this.authManager.getAuthHeaders(),o=this.optionManager.getOption("httpHost"),r=this.optionManager.getOption("httpPort"),s=this.optionManager.getOption("isSecure"),a="".concat(s?"https":"http","://").concat(o).concat(r?":".concat(r):"","/v1/channel/").concat(this.name,"/messages"),c={messages:[{alias:null==t?void 0:t.alias,event:null==t?void 0:t.event,data:e}]},this.logger.trace("Sending REST publish to ".concat(a," for channel ").concat(this.name,":"),c),[4,this.httpClient.post(a,c,n)];case 2:return u=i.sent(),this.logger.info("Published message to REST channel: ".concat(this.name)),[2,u];case 3:throw h=i.sent(),this.logger.error("Error publishing to REST channel ".concat(this.name,":"),h),this.emit(m.FAILED,{channelName:this.name,error:h instanceof Error?h:new Error("Unknown error"),action:"publish"}),h;case 4:return[2]}})})},n.prototype.reset=function(){this.logger.info("Resetting REST channel: ".concat(this.name)),this.removeAllListeners(),this.logger.debug("REST channel ".concat(this.name," reset complete"))},n}(C),T=function(){function e(e,t){this.channels=new Map,this.channelRefCounts=new Map,this.wsClient=e,this.logger=t}return e.prototype.get=function(e){var t=!this.channels.has(e);t&&(this.logger.debug("Creating new socket channel: ".concat(e)),this.channels.set(e,new E(e,this.wsClient,this.logger)));var n=this.channelRefCounts.get(e)||0;return this.channelRefCounts.set(e,n+1),t||0!==n?this.logger.debug("Channel ".concat(e," reference count: ").concat(n+1)):this.logger.debug("Channel ".concat(e," re-acquired (was kept for auto-resubscribe, ref count: 1)")),this.channels.get(e)},e.prototype.release=function(e){var t=this.channelRefCounts.get(e);if(void 0===t||t<0)this.logger.warn("Attempted to release channel ".concat(e," with no active references"));else if(0!==t)if(1===t){var n=this.channels.get(e);if(n&&n.hasCallback())this.channelRefCounts.set(e,0),this.logger.debug("Last reference to channel ".concat(e," released - keeping for auto-resubscribe (ref count: 0)"));else{if(this.logger.debug("Last reference to channel ".concat(e," released - cleaning up")),n){try{n.reset()}catch(t){this.logger.warn("Failed to reset channel ".concat(e," during cleanup:"),t)}this.channels.delete(e),this.logger.debug("Channel ".concat(e," removed from manager"))}this.channelRefCounts.delete(e)}}else this.channelRefCounts.set(e,t-1),this.logger.debug("Channel ".concat(e," reference count: ").concat(t-1));else this.logger.debug("Attempted to release channel ".concat(e," that has ref count 0 (kept for auto-resubscribe)"))},e.prototype.getAllChannels=function(){return Array.from(this.channels.values())},e.prototype.has=function(e){return this.channels.has(e)},e.prototype.remove=function(e){var t=this.channels.get(e);t&&(t.removeAllListeners(),this.channels.delete(e),this.logger.debug("Channel ".concat(e," removed")))},e.prototype.pendingSubscribeAllChannels=function(){for(var e=0,t=this.getAllChannels();e<t.length;e++){t[e].setPendingSubscribe(!0)}},e.prototype.resubscribeAllChannels=function(){return o(this,void 0,void 0,function(){var e,t,n,o,r,s;return i(this,function(i){switch(i.label){case 0:if(e=this.getAllChannels(),t=e.filter(function(e){return e.hasCallback()}),0===t.length)return this.logger.debug("No channels with active subscriptions to resubscribe"),[2];this.logger.debug("Resubscribing to ".concat(t.length," channel(s)")),n=0,o=t,i.label=1;case 1:if(!(n<o.length))return[3,6];r=o[n],i.label=2;case 2:return i.trys.push([2,4,,5]),[4,r.resubscribe()];case 3:return i.sent(),this.logger.debug("Resubscribed to channel: ".concat(r.getName())),[3,5];case 4:return s=i.sent(),this.logger.error("Failed to resubscribe to channel ".concat(r.getName(),":"),s),[3,5];case 5:return n++,[3,1];case 6:return[2]}})})},e.prototype.reset=function(){this.logger.debug("Resetting all socket channels"),this.channels.forEach(function(e){return e.reset()}),this.channels.clear(),this.channelRefCounts.clear()},e}(),I=function(){function e(e,t,n,o){this.channels=new Map,this.httpClient=e,this.authManager=t,this.optionManager=n,this.logger=o}return e.prototype.get=function(e){return this.channels.has(e)||(this.logger.debug("Creating new REST channel: ".concat(e)),this.channels.set(e,new w(e,this.httpClient,this.authManager,this.optionManager,this.logger))),this.channels.get(e)},e.prototype.publishBatch=function(e,t){return o(this,void 0,void 0,function(){var n,o,r,s,a,c;return i(this,function(i){switch(i.label){case 0:return n=this.authManager.getAuthHeaders(),o=this.optionManager.getOption("httpHost"),r=this.optionManager.getOption("httpPort"),s=this.optionManager.getOption("isSecure"),a="".concat(s?"https":"http","://").concat(o).concat(r?":".concat(r):"","/v1/channels/messages"),c={channels:e,messages:t},this.logger.debug("Publishing batch to ".concat(a)),this.logger.debug("Request payload: ".concat(JSON.stringify(c))),this.logger.debug("Headers: ".concat(JSON.stringify(n))),[4,this.httpClient.post(a,c,n)];case 1:return[2,i.sent()]}})})},e.prototype.has=function(e){return this.channels.has(e)},e.prototype.remove=function(e){var t=this.channels.get(e);t&&(t.removeAllListeners(),this.channels.delete(e),this.logger.debug("REST channel ".concat(e," removed")))},e.prototype.reset=function(){this.logger.debug("Resetting all REST channels"),this.channels.forEach(function(e){return e.reset()}),this.channels.clear()},e}(),R=function(e){function n(t,n,o,i,r){var s=e.call(this)||this;return s.socket=null,s.reconnectAttempts=0,s.isReconnecting=!1,s.isIntentionalDisconnect=!1,s._isResetting=!1,s.pendingPings=new Map,s.pingCounter=0,s.optionManager=t,s.authManager=n,s.wsClient=o,s.channelManager=i,s.logger=r,s.setupAuthListeners(),s.logger.info("Connection instance initialized"),s.emit(v.INITIALIZED),s}return t(n,e),n.prototype.getAuthenticatedWsUrl=function(){var e=this.optionManager.getOption("isSecure"),t=this.optionManager.getOption("wsHost"),n=this.optionManager.getOption("wsPort"),o="".concat(e?"wss":"ws","://").concat(t).concat(n?":".concat(n):"","/v1");return this.authManager.getAuthenticateUrl(o)},n.prototype.connect=function(){return o(this,void 0,void 0,function(){var e,t;return i(this,function(n){switch(n.label){case 0:if(this._isResetting)return this.logger.debug("Connection attempt blocked - connection is resetting"),[2];n.label=1;case 1:return n.trys.push([1,4,,5]),this.emit(v.CONNECTING,{attempt:1}),this.authManager.shouldAutoAuthenticate()?[4,this.authManager.authenticate()]:[3,3];case 2:n.sent(),n.label=3;case 3:return e=this.getAuthenticatedWsUrl(),this.wsClient.connect(e),this.socket=this.wsClient.getSocket(),this.socket&&this.setupSocketListeners(),[3,5];case 4:return t=n.sent(),this.handleAuthError(t),[3,5];case 5:return[2]}})})},n.prototype.isConnected=function(){return this.wsClient.isConnected()},n.prototype.isResetting=function(){return this._isResetting},n.prototype.ping=function(){var e=this;return new Promise(function(t,n){if(e.socket&&e.socket.readyState===WebSocket.OPEN){var o=++e.pingCounter,i=performance.now();e.pendingPings.set(o.toString(),{startTime:i,resolve:t,reject:n});var r=setTimeout(function(){e.pendingPings.delete(o.toString()),n(new Error("Ping timeout"))},e.optionManager.getOption("pingTimeoutMs")||1e4);e.pendingPings.get(o.toString()).timeout=r;var s={action:a.PING,timestamp:o};try{e.socket.send(JSON.stringify(s)),e.logger.debug("Sent ping with ID: ".concat(o))}catch(t){clearTimeout(r),e.pendingPings.delete(o.toString()),n(t instanceof Error?t:new Error(String(t)))}}else n(new Error("WebSocket is not connected"))})},n.prototype.setupSocketListeners=function(){var e=this;this.socket&&(this.socket.onopen=function(){e.logger.info("WebSocket connection opened"),e.reconnectAttempts=0,e.isReconnecting=!1,e.isIntentionalDisconnect=!1,e.emit(v.OPENED,{}),e.setupPingHandler(),e.optionManager.getOption("autoResubscribe")&&e.channelManager.resubscribeAllChannels()},this.socket.onclose=function(t){e.logger.info("WebSocket connection closed: ".concat(t.code," ").concat(t.reason)),e.pingTimeout&&(clearTimeout(e.pingTimeout),e.pingTimeout=void 0),e.emit(v.CLOSED,{code:t.code,reason:t.reason,wasClean:t.wasClean}),e.channelManager.pendingSubscribeAllChannels(),e.isReconnecting||e.isIntentionalDisconnect||!e.optionManager.getOption("autoReconnect")||e.handleConnectionClosed()},this.socket.onerror=function(t){e.logger.error("WebSocket connection error:",t),e.channelManager.pendingSubscribeAllChannels(),e.emit(v.FAILED,{error:new Error("WebSocket connection error"),context:"websocket"})},this.socket.onmessage=function(t){try{var n=JSON.parse(t.data);if(e.logger.debug("Received message:",n),n.action===a.CONNECTED){var o=n;e.emit(v.CONNECTED,{connectionId:o.connection_id,connectionDetails:o.connection_details})}else n.action===a.DISCONNECTED?e.emit(v.DISCONNECTED,{}):n.action===a.PONG&&e.handlePongResponse(n)}catch(t){e.logger.error("Error processing message:",t),e.emit(v.FAILED,{error:t instanceof Error?t:new Error("Unknown error"),context:"message_processing"})}},this.logger.debug("Socket listeners configured"))},n.prototype.setupAuthListeners=function(){this.authManager.on(k.TOKEN_EXPIRED,this.handleTokenExpired.bind(this)),this.authManager.on(k.TOKEN_ERROR,this.handleAuthError.bind(this)),this.authManager.on(k.AUTH_ERROR,this.handleAuthError.bind(this)),this.logger.debug("Auth listeners configured")},n.prototype.setupPingHandler=function(){var e=this;if(this.socket){var t=this.optionManager.getOption("pingTimeoutMs")||6e4;this.socket.onping=function(){e.logger.debug("Ping received from server (Node.js only)"),e.pingTimeout&&clearTimeout(e.pingTimeout),e.pingTimeout=setTimeout(function(){e.handleConnectionInterrupted()},t)},this.socket.onpong=function(){e.logger.debug("Pong received from server (Node.js only)")},this.logger.debug("Ping handler configured")}},n.prototype.handlePongResponse=function(e){var t,n=null===(t=e.timestamp)||void 0===t?void 0:t.toString();if(n){var o=this.pendingPings.get(n);if(o){var i=performance.now()-o.startTime;o.timeout&&clearTimeout(o.timeout),this.pendingPings.delete(n),this.logger.debug("Ping ".concat(n," completed with RTT: ").concat(i.toFixed(2),"ms")),o.resolve(i)}else this.logger.debug("Received pong for unknown ping ID: ".concat(n))}else this.logger.debug("Received pong without ping ID, ignoring")},n.prototype.handleConnectionInterrupted=function(){this.logger.warn("Connection interrupted - no ping received within timeout period"),this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=void 0),this.disconnect(),this.handleConnectionClosed()},n.prototype.handleConnectionClosed=function(){return o(this,void 0,void 0,function(){var e;return i(this,function(t){switch(t.label){case 0:return(null===(e=this.socket)||void 0===e?void 0:e.readyState)===WebSocket.CLOSING?(this.logger.debug("Connection close handled - socket already closing"),[2]):this.reconnectAttempts>=this.optionManager.getOption("maxReconnectAttempts")?(this.logger.debug("Max reconnection attempts reached - not attempting reconnection"),[2]):this.optionManager.getOption("autoReconnect")?(this.logger.info("Initiating automatic reconnection"),[4,this.attemptReconnection()]):[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}})})},n.prototype.handleTokenExpired=function(){return o(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return[4,this.connect()];case 1:return e.sent(),[2]}})})},n.prototype.handleAuthError=function(e){this.emit(v.FAILED,{error:e,context:"authentication"}),this.disconnect()},n.prototype.calculateReconnectDelay=function(){var e=this.optionManager.getOption("initialReconnectDelayMs"),t=this.optionManager.getOption("maxReconnectDelayMs"),n=this.optionManager.getOption("reconnectBackoffMultiplier"),o=e*Math.pow(n,this.reconnectAttempts);return Math.min(o,t)},n.prototype.attemptReconnection=function(){return o(this,void 0,void 0,function(){var e,t,n,o,r=this;return i(this,function(s){switch(s.label){case 0:if(this.isReconnecting)return this.logger.debug("Reconnection already in progress"),[2];e=this.optionManager.getOption("maxReconnectAttempts"),this.isReconnecting=!0,this.logger.info("Starting reconnection attempts (max: ".concat(e,")")),t=function(){var t,o,s;return i(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=n.calculateReconnectDelay(),n.logger.debug("Reconnection attempt ".concat(n.reconnectAttempts+1,"/").concat(e," after ").concat(t,"ms")),n.emit(v.CONNECTING,{attempt:n.reconnectAttempts+1}),[4,new Promise(function(e){return setTimeout(e,t)})];case 1:return i.sent(),o=new Promise(function(e,t){var n,o=!1;n=setTimeout(function(){o||(o=!0,t(new Error("Connection attempt timed out")))},r.optionManager.getOption("connectTimeoutMs")||1e4),r.connect().then(function(){o||(o=!0,clearTimeout(n),setTimeout(function(){var n;(null===(n=r.socket)||void 0===n?void 0:n.readyState)===WebSocket.OPEN?e(!0):t(new Error("WebSocket connection failed"))},100))}).catch(function(e){o||(o=!0,clearTimeout(n),t(e))})}),[4,o];case 2:return i.sent(),[2,{value:void 0}];case 3:return s=i.sent(),n.reconnectAttempts++,n.logger.warn("Reconnection attempt failed: ".concat(s)),n.reconnectAttempts>=e?(n.logger.error("Max reconnection attempts reached"),n.emit(v.FAILED,{error:s instanceof Error?s:new Error(String(s)),context:"reconnection"}),n.isReconnecting=!1,[2,"break"]):[3,4];case 4:return[2]}})},n=this,s.label=1;case 1:return this.reconnectAttempts<e?[5,t()]:[3,3];case 2:return"object"==typeof(o=s.sent())?[2,o.value]:"break"===o?[3,3]:[3,1];case 3:return[2]}})})},n.prototype.disconnect=function(){this.isReconnecting=!1,this.isIntentionalDisconnect=!0,this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=void 0),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.pendingPings.forEach(function(e,t){e.timeout&&clearTimeout(e.timeout),e.reject(new Error("Connection closed"))}),this.pendingPings.clear(),this.emit(v.CLOSING,{}),this.wsClient.disconnect(),this.emit(v.CLOSED,{})},n.prototype.reset=function(){this.logger.info("Resetting Connection instance"),this._isResetting=!0,this.stopAllPendingOperations(),this.cleanupTimers(),this.emit(v.CLOSING,{}),this.wsClient.disconnect(),this.emit(v.CLOSED,{}),this.resetState(),this.removeAllListeners(),this.logger.info("Connection reset completed")},n.prototype.stopAllPendingOperations=function(){this.isReconnecting=!1,this.pendingPings.forEach(function(e,t){e.timeout&&clearTimeout(e.timeout),e.reject(new Error("Connection reset"))}),this.pendingPings.clear()},n.prototype.cleanupTimers=function(){this.pingTimeout&&(clearTimeout(this.pingTimeout),this.pingTimeout=void 0),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout)},n.prototype.resetState=function(){this.reconnectAttempts=0,this.isIntentionalDisconnect=!1,this._isResetting=!1,this.socket=null,this.wsClient.reset()},n}(d),M=function(){function e(e,t){this.instanceId=e,this.optionManager=t}return e.prototype.createLogger=function(e){return new g(this.instanceId,e,this.optionManager)},e}();function A(e,t,n){void 0===n&&(n={}),e.register("optionManager",function(){return new h(n)},{dependencies:[]}),e.register("httpClient",function(){return new l},{dependencies:[]}),e.register("loggerFactory",function(e){return new M(t,e.resolve("optionManager"))},{dependencies:["optionManager"]}),e.register("authLogger",function(e){return e.resolve("loggerFactory").createLogger("AuthManager")},{dependencies:["loggerFactory"]}),e.register("connectionLogger",function(e){return e.resolve("loggerFactory").createLogger("Connection")},{dependencies:["loggerFactory"]}),e.register("wsClientLogger",function(e){return e.resolve("loggerFactory").createLogger("WebSocketClient")},{dependencies:["loggerFactory"]}),e.register("socketChannelLogger",function(e){return e.resolve("loggerFactory").createLogger("SocketChannelManager")},{dependencies:["loggerFactory"]}),e.register("authManager",function(e){return new y(e.resolve("optionManager"),e.resolve("httpClient"),e.resolve("authLogger"))},{dependencies:["optionManager","httpClient","authLogger"]}),e.register("wsClient",function(e){return new S(e.resolve("wsClientLogger"))},{dependencies:["wsClientLogger"]}),e.register("socketChannelManager",function(e){return new T(e.resolve("wsClient"),e.resolve("socketChannelLogger"))},{dependencies:["wsClient","socketChannelLogger"]}),e.register("connection",function(e){return new R(e.resolve("optionManager"),e.resolve("authManager"),e.resolve("wsClient"),e.resolve("socketChannelManager"),e.resolve("connectionLogger"))},{dependencies:["optionManager","authManager","wsClient","socketChannelManager","connectionLogger"]})}function O(e,t,n){void 0===n&&(n={}),e.register("optionManager",function(){return new h(n)},{dependencies:[]}),e.register("httpClient",function(){return new l},{dependencies:[]}),e.register("loggerFactory",function(e){return new M(t,e.resolve("optionManager"))},{dependencies:["optionManager"]}),e.register("authLogger",function(e){return e.resolve("loggerFactory").createLogger("AuthManager")},{dependencies:["loggerFactory"]}),e.register("restChannelLogger",function(e){return e.resolve("loggerFactory").createLogger("RestChannelManager")},{dependencies:["loggerFactory"]}),e.register("authManager",function(e){return new y(e.resolve("optionManager"),e.resolve("httpClient"),e.resolve("authLogger"))},{dependencies:["optionManager","httpClient","authLogger"]}),e.register("restChannelManager",function(e){return new I(e.resolve("httpClient"),e.resolve("authManager"),e.resolve("optionManager"),e.resolve("restChannelLogger"))},{dependencies:["httpClient","authManager","optionManager","restChannelLogger"]})}function N(e,t,n,o){void 0===o&&(o={}),"socket"===t?A(e,n,o):O(e,n,o);try{e.validate()}catch(e){throw new Error("Service container validation failed for ".concat(t," instance '").concat(n,"': ").concat(e instanceof Error?e.message:String(e)))}}function U(){var e=BigInt(Date.now()).toString(16).padStart(12,"0"),t=Array.from({length:20},function(){return Math.floor(16*Math.random()).toString(16)}).join("");return"".concat(e.slice(0,8),"-").concat(e.slice(8,12),"-7").concat(t.slice(0,3),"-").concat((8+(3&parseInt(t[0],16))).toString(16)).concat(t.slice(3,6),"-").concat(t.slice(6,16))}var D=function(){function e(e){this.instanceId="rest_".concat(U()),this.container=new c(this.instanceId),N(this.container,"rest",this.instanceId,e),this.optionManager=this.container.resolve("optionManager"),this.channels=this.container.resolve("restChannelManager");var t=this.container.resolve("loggerFactory");this.logger=t.createLogger("REST"),this.logger.info("Rest instance created")}return e.prototype.reset=function(){this.logger.info("Resetting REST instance"),this.channels.reset(),this.optionManager.reset(),this.container.clearInstances()},e.prototype.getInstanceId=function(){return this.instanceId},e}(),P=function(){function e(e){this.instanceId="socket_".concat(U()),this.abortController=new AbortController,this.container=new c(this.instanceId),N(this.container,"socket",this.instanceId,e),this.optionManager=this.container.resolve("optionManager"),this.authManager=this.container.resolve("authManager"),this.connection=this.container.resolve("connection"),this.channels=this.container.resolve("socketChannelManager");var t=this.container.resolve("loggerFactory");this.logger=t.createLogger("Socket"),this.optionManager.getOption("autoConnect")&&(this.logger.info("Auto-connecting socket"),this.connection.connect()),this.logger.info("Socket instance created")}return e.prototype.reset=function(){this.logger.info("Resetting Socket instance"),this.abortController.abort(),this.abortController=new AbortController,this.connection.reset(),this.channels.reset(),this.authManager.reset(),this.optionManager.reset(),this.container.clearInstances(),this.logger.info("Socket instance reset completed")},e.prototype.getAbortSignal=function(){return this.abortController.signal},e.prototype.getInstanceId=function(){return this.instanceId},e}(),L=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return t(n,e),n.prototype.mock=function(e,t){this.clearService(e),this.register(e,function(){return t},{lifetime:"singleton"})},n.prototype.override=function(e,t){this.clearService(e),this.register(e,t,{lifetime:"singleton"})},n.prototype.clearService=function(e){this.instances.delete(e),this.definitions.delete(e)},n}(c);function B(e,t){void 0===e&&(e="test-socket"),void 0===t&&(t={});var n=new L(e);return A(n,e,t),n}function q(e,t){void 0===e&&(e="test-rest"),void 0===t&&(t={});var n=new L(e);return O(n,e,t),n}function _(e){var t="undefined"!=typeof global?global:window;if(t.jest&&"function"==typeof t.jest.fn){var n=t.jest.fn();return void 0!==e&&n.mockReturnValue(e),n}var o=function(){return e};return o.mockReturnValue=function(e){return o._returnValue=e,o},o.mockResolvedValue=function(e){return o._returnValue=Promise.resolve(e),o},o.mockRejectedValue=function(e){return o._returnValue=Promise.reject(e),o},o.mockImplementation=function(e){return Object.setPrototypeOf(o,e),o},o.mockClear=function(){},o.mockReset=function(){},o}var x={createOptionManager:function(e){return void 0===e&&(e={}),n({getOption:_(),setOption:_(),reset:_()},e)},createAuthManager:function(e){return void 0===e&&(e={}),n({authenticate:_(),isAuthenticated:_(!1),shouldAutoAuthenticate:_(!1),getAuthenticateUrl:_(""),requestToken:_(),getCurrentToken:_(null),getToken:_(null),clearToken:_(),getAuthHeaders:_({}),getAuthQueryParams:_(""),reset:_(),on:_(),off:_(),emit:_(),removeAllListeners:_()},e)},createWebSocketClient:function(e){return void 0===e&&(e={}),n({connect:_(),disconnect:_(),isConnected:_(!1),getSocket:_(null),send:_(),reset:_()},e)},createConnection:function(e){return void 0===e&&(e={}),n({connect:_(),disconnect:_(),isConnected:_(!1),reset:_(),on:_(),off:_(),emit:_(),removeAllListeners:_()},e)},createSocketChannelManager:function(e){return void 0===e&&(e={}),n({get:_(),has:_(!1),remove:_(),reset:_(),resubscribeAllChannels:_(),pendingSubscribeAllChannels:_()},e)},createHttpClient:function(e){return void 0===e&&(e={}),n({get:_(),post:_(),put:_(),delete:_(),patch:_()},e)},createLogger:function(e){return void 0===e&&(e={}),n({error:_(),warn:_(),info:_(),debug:_(),trace:_()},e)},createLoggerFactory:function(e){void 0===e&&(e={});var t=x.createLogger();return n({createLogger:_(t)},e)}},F={createMockedSocketContainer:function(e){void 0===e&&(e="test-socket");var t=new L(e),n={optionManager:x.createOptionManager(),authManager:x.createAuthManager(),wsClient:x.createWebSocketClient(),connection:x.createConnection(),socketChannelManager:x.createSocketChannelManager(),logger:x.createLogger(),loggerFactory:x.createLoggerFactory()};return t.mock("optionManager",n.optionManager),t.mock("authManager",n.authManager),t.mock("wsClient",n.wsClient),t.mock("connection",n.connection),t.mock("socketChannelManager",n.socketChannelManager),t.mock("loggerFactory",n.loggerFactory),{container:t,mocks:n}},createPartiallyMockedContainer:function(e,t){void 0===e&&(e=["optionManager"]),void 0===t&&(t={});var n=B("test-partial",t);return["authManager","wsClient","connection","socketChannelManager","loggerFactory"].filter(function(t){return!e.includes(t)}).forEach(function(e){switch(e){case"authManager":n.mock(e,x.createAuthManager());break;case"wsClient":n.mock(e,x.createWebSocketClient());break;case"connection":n.mock(e,x.createConnection());break;case"socketChannelManager":n.mock(e,x.createSocketChannelManager());break;case"loggerFactory":n.mock(e,x.createLoggerFactory())}}),n}},H={Rest:D,Socket:P};export{k as AuthEvents,m as ChannelEvents,v as ConnectionEvents,x as MockFactory,H as QPub,D as Rest,c as ServiceContainer,P as Socket,L as TestContainer,F as TestUtils,N as bootstrapContainer,q as createTestRestContainer,B as createTestSocketContainer,O as registerRestServices,A as registerSocketServices};
//# sourceMappingURL=qpub.esm.js.map
